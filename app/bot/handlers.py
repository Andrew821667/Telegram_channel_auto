"""
Telegram Bot Handlers
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è –¥—Ä–∞—Ñ—Ç–æ–≤.
"""

import asyncio
import html
from datetime import datetime
from typing import Optional, Dict, List

from aiogram import Bot, Dispatcher, F, Router
from aiogram.filters import Command, CommandStart
from aiogram.types import Message, CallbackQuery, FSInputFile, BotCommand, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy import select, update, func
from sqlalchemy.ext.asyncio import AsyncSession

from app.config import settings
from app.models.database import (
    PostDraft, Publication, RawArticle,
    FeedbackLabel, PersonalPost, PostComment, get_db
)
from app.bot.keyboards import (
    get_draft_review_keyboard,
    get_confirm_keyboard,
    get_reader_keyboard,
    get_main_menu_keyboard,
    get_rejection_reasons_keyboard,
    get_opinion_keyboard,
    get_edit_mode_keyboard,
    get_llm_selection_keyboard
)
from app.bot.middleware import DbSessionMiddleware
from app.modules.llm_provider import get_llm_provider
from app.modules.vector_search import get_vector_search
from app.modules.analytics import AnalyticsService
from app.modules.channel_moderation import ChannelModeration
import structlog

logger = structlog.get_logger()

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Bot —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–µ–Ω–∏–≤–æ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è aiohttp –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ)
_bot: Optional[Bot] = None
_selected_llm_provider: str = settings.default_llm_provider  # –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
_channel_moderator: Optional[ChannelModeration] = None  # –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∫–∞–Ω–∞–ª–∞
dp = Dispatcher()
router = Router()


def get_bot() -> Bot:
    """
    –ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è).

    Bot —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è aiohttp –∫–ª–∏–µ–Ω—Ç–∞
    –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è (–≤–∞–∂–Ω–æ –¥–ª—è Celery worker).
    """
    global _bot
    if _bot is None:
        _bot = Bot(token=settings.telegram_bot_token)
    return _bot


# FSM States –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
class EditDraft(StatesGroup):
    waiting_for_manual_edit = State()
    waiting_for_llm_edit = State()


# ====================
# Channel Moderation
# ====================

def get_channel_moderator() -> ChannelModeration:
    """
    –ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ –∫–∞–Ω–∞–ª–∞ (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è).

    –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ.
    """
    global _channel_moderator
    if _channel_moderator is None:
        _channel_moderator = ChannelModeration()
        _channel_moderator.set_bot(get_bot())
        logger.info("Channel moderator initialized")
    return _channel_moderator


@router.channel_post()
async def moderate_channel_comment(message: Message):
    """
    –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ –ø–æ—Å—Ç–∞–º –≤ –∫–∞–Ω–∞–ª–µ @legal_ai_pro.

    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏:
    - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∞–º–∞ –∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
    - AI –∞–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—É–¥–∞–ª–µ–Ω–∏–µ/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –Ω–∞—à–µ–º—É –∫–∞–Ω–∞–ª—É
        if str(message.chat.id) != str(settings.telegram_channel_id_numeric):
            return  # –ù–µ –Ω–∞—à –∫–∞–Ω–∞–ª

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if not message.text:
            return  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º–µ–¥–∏–∞ –∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π

        logger.info(
            f"Moderating comment from user {message.from_user.id} in channel {message.chat.id}: {message.text[:100]}..."
        )

        # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä
        moderator = get_channel_moderator()

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        moderation_result = await moderator.moderate_comment(message, str(message.chat.id))

        # –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ –æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        if moderation_result['moderated']:
            await moderator.take_moderation_action(message, moderation_result)

            # –õ–æ–≥–∏—Ä—É–µ–º –º–æ–¥–µ—Ä–∞—Ü–∏—é
            logger.info(
                f"Comment moderated: action={moderation_result['action']}, "
                f"reason={moderation_result['reason']}, "
                f"confidence={moderation_result['confidence']:.2f}"
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            try:
                from app.models.database import PostComment, get_db
                async with get_db() as db:
                    # –ò—â–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é –ø–æ message_id –∏–ª–∏ reply_to_message
                    publication_id = None
                    if message.reply_to_message:
                        # –≠—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞–π–¥–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é
                        from sqlalchemy import select
                        result = await db.execute(
                            select(PostComment.publication_id).where(
                                PostComment.telegram_message_id == message.reply_to_message.message_id
                            )
                        )
                        publication_id = result.scalar()

                    if publication_id:
                        comment = PostComment(
                            publication_id=publication_id,
                            telegram_message_id=message.message_id,
                            user_id=message.from_user.id,
                            username=message.from_user.username,
                            text=message.text,
                            moderated=True,
                            moderation_action=moderation_result['action'],
                            moderation_reason=moderation_result['reason'],
                            moderation_confidence=moderation_result['confidence']
                        )
                        db.add(comment)
                        await db.commit()

            except Exception as e:
                logger.error(f"Failed to save moderation data: {e}")

    except Exception as e:
        logger.error(f"Error in channel comment moderation: {e}")


# ====================
# Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
# ====================

async def check_admin(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."""
    return user_id == settings.telegram_admin_id


# ====================
# –ö–æ–º–∞–Ω–¥—ã
# ====================

@router.message(CommandStart())
async def cmd_start(message: Message):
    logger.info(f"Start command received from user {message.from_user.id}")
    logger.info(f"Message text: {message.text}")
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    if not await check_admin(message.from_user.id):
        await message.answer("‚õîÔ∏è –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return

    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AI-News Aggregator!\n\n"
        "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –ò–ò –≤ —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—é.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/drafts - –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –¥—Ä–∞—Ñ—Ç—ã\n"
        "/stats - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n"
        "/help - –ø–æ–º–æ—â—å",
        reply_markup=get_main_menu_keyboard()
    )


@router.message(Command("drafts"))
async def cmd_drafts(message: Message, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –¥—Ä–∞—Ñ—Ç—ã –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏."""
    if not await check_admin(message.from_user.id):
        return

    # –ü–æ–ª—É—á–∞–µ–º –í–°–ï –¥—Ä–∞—Ñ—Ç—ã –≤ —Å—Ç–∞—Ç—É—Å–µ pending_review (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ)
    result = await db.execute(
        select(PostDraft)
        .where(PostDraft.status == 'pending_review')
        .order_by(PostDraft.created_at.desc())
    )
    drafts = list(result.scalars().all())

    if not drafts:
        await message.answer("üì≠ –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥—Ä–∞—Ñ—Ç–æ–≤ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏.")
        return

    await message.answer(f"üìù –ù–∞–π–¥–µ–Ω–æ {len(drafts)} –¥—Ä–∞—Ñ—Ç–æ–≤. –û—Ç–ø—Ä–∞–≤–ª—è—é...")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –¥—Ä–∞—Ñ—Ç (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π publisher_max_posts_per_day)
    max_drafts = min(len(drafts), settings.publisher_max_posts_per_day)
    for index, draft in enumerate(drafts[:max_drafts], start=1):
        await send_draft_for_review(message.chat.id, draft, db, draft_number=index)


@router.message(Command("stats"))
async def cmd_stats(message: Message, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É."""
    if not await check_admin(message.from_user.id):
        return

    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats_text = await get_statistics(db)
    await message.answer(stats_text, parse_mode="HTML")


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å."""
    if not await check_admin(message.from_user.id):
        return

    help_text = """
üìö <b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É</b>

<b>–ö–æ–º–∞–Ω–¥—ã:</b>
/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/drafts - –ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –¥—Ä–∞—Ñ—Ç—ã
/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
/fetch - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –≤—Ä—É—á–Ω—É—é
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

<b>–ú–æ–¥–µ—Ä–∞—Ü–∏—è –¥—Ä–∞—Ñ—Ç–æ–≤:</b>
‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å - –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª
‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å - –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –¥—Ä–∞—Ñ—Ç

<b>Workflow:</b>
1. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏ (09:00 MSK)
2. AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥—Ä–∞—Ñ—Ç—ã
3. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –¥—Ä–∞—Ñ—Ç–∞—Ö
4. –í—ã –º–æ–¥–µ—Ä–∏—Ä—É–µ—Ç–µ –∫–∞–∂–¥—ã–π –¥—Ä–∞—Ñ—Ç
5. –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ –∫–∞–Ω–∞–ª

‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> –í—Å–µ –¥—Ä–∞—Ñ—Ç—ã —Ç—Ä–µ–±—É—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π!
"""
    await message.answer(help_text, parse_mode="HTML")


@router.message(Command("fetch"))
async def cmd_fetch(message: Message):
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –≤—Ä—É—á–Ω—É—é."""
    if not await check_admin(message.from_user.id):
        return

    await message.answer("üîÑ –ó–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π...")

    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É Celery
        from app.tasks.celery_tasks import manual_workflow
        task = manual_workflow.delay()

        await message.answer(
            f"‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞!\n"
            f"ID –∑–∞–¥–∞—á–∏: <code>{task.id}</code>\n\n"
            f"–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º–µ—Ç 5-10 –º–∏–Ω—É—Ç.\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /drafts —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –¥—Ä–∞—Ñ—Ç—ã.",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error("fetch_error", error=str(e))
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {str(e)}")


# ====================
# Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
# ====================

@router.callback_query(F.data.startswith("publish:"))
async def callback_publish(callback: CallbackQuery, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    draft_id = int(callback.data.split(":")[1])

    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await callback.message.edit_reply_markup(
        reply_markup=get_confirm_keyboard("publish", draft_id)
    )
    await callback.answer("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é")


@router.callback_query(F.data.startswith("confirm_publish:"))
async def callback_confirm_publish(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏."""
    # –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∞–ª–∞
    await callback.answer("–ü—É–±–ª–∏–∫—É—é...")

    if not await check_admin(callback.from_user.id):
        logger.warning("confirm_publish_no_access", user_id=callback.from_user.id)
        return

    draft_id = int(callback.data.split(":")[1])
    logger.info("confirm_publish_start", draft_id=draft_id, user_id=callback.from_user.id)

    # –ü—É–±–ª–∏–∫—É–µ–º –ø–æ—Å—Ç
    success = await publish_draft(draft_id, db, callback.from_user.id)
    logger.info("confirm_publish_result", draft_id=draft_id, success=success)

    try:
        logger.info("confirm_publish_updating_message", draft_id=draft_id, has_photo=bool(callback.message.photo))
        if success:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (photo –∏–ª–∏ text)
            if callback.message.photo:
                logger.info("confirm_publish_edit_caption", draft_id=draft_id)
                await callback.message.edit_caption(
                    caption=f"‚úÖ –î—Ä–∞—Ñ—Ç #{draft_id} —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!",
                    reply_markup=None  # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
                )
            else:
                logger.info("confirm_publish_edit_text", draft_id=draft_id)
                await callback.message.edit_text(
                    text=f"‚úÖ –î—Ä–∞—Ñ—Ç #{draft_id} —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!",
                    reply_markup=None  # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
                )
            logger.info("confirm_publish_message_updated", draft_id=draft_id)
        else:
            if callback.message.photo:
                await callback.message.edit_caption(
                    caption=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞—Ñ—Ç–∞ #{draft_id}",
                    reply_markup=None
                )
            else:
                await callback.message.edit_text(
                    text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞—Ñ—Ç–∞ #{draft_id}",
                    reply_markup=None
                )
    except Exception as e:
        logger.error("callback_message_edit_error", error=str(e), draft_id=draft_id, error_type=type(e).__name__)
        # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        status_msg = f"‚úÖ –î—Ä–∞—Ñ—Ç #{draft_id} —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!" if success else f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞—Ñ—Ç–∞ #{draft_id}"
        await callback.message.answer(status_msg)


@router.callback_query(F.data.startswith("reject:"))
async def callback_reject(callback: CallbackQuery, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    draft_id = int(callback.data.split(":")[1])

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
    await callback.message.edit_reply_markup(
        reply_markup=get_rejection_reasons_keyboard(draft_id)
    )
    await callback.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è")


@router.callback_query(F.data.startswith("reject_reason:"))
async def callback_reject_reason(callback: CallbackQuery, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è."""
    # –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∞–ª–∞
    await callback.answer("–û—Ç–∫–ª–æ–Ω—è—é...")

    if not await check_admin(callback.from_user.id):
        return

    parts = callback.data.split(":")
    draft_id = int(parts[1])
    reason = parts[2]

    # –û—Ç–∫–ª–æ–Ω—è–µ–º –¥—Ä–∞—Ñ—Ç
    success = await reject_draft(draft_id, reason, db, callback.from_user.id)

    if success:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (photo –∏–ª–∏ text)
        if callback.message.photo:
            await callback.message.edit_caption(
                caption=f"‚ùå –î—Ä–∞—Ñ—Ç #{draft_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω\n–ü—Ä–∏—á–∏–Ω–∞: {reason}"
            )
        else:
            await callback.message.edit_text(
                f"‚ùå –î—Ä–∞—Ñ—Ç #{draft_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω\n–ü—Ä–∏—á–∏–Ω–∞: {reason}"
            )
    else:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –¥—Ä–∞—Ñ—Ç–∞", show_alert=True)


@router.callback_query(F.data.startswith("edit:"))
async def callback_edit(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞."""
    await callback.answer()

    if not await check_admin(callback.from_user.id):
        await callback.message.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞")
        return

    draft_id = int(callback.data.split(":")[1])

    await callback.message.answer(
        "‚úèÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥—Ä–∞—Ñ—Ç–∞:",
        reply_markup=get_edit_mode_keyboard(draft_id)
    )


@router.callback_query(F.data.startswith("edit_manual:"))
async def callback_edit_manual(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    await callback.answer()

    if not await check_admin(callback.from_user.id):
        await callback.message.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞")
        return

    draft_id = int(callback.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥—Ä–∞—Ñ—Ç
    result = await db.execute(
        select(PostDraft).where(PostDraft.id == draft_id)
    )
    draft = result.scalar_one_or_none()

    if not draft:
        await callback.answer("‚ùå –î—Ä–∞—Ñ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    await state.update_data(draft_id=draft_id)
    await state.set_state(EditDraft.waiting_for_manual_edit)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    await callback.message.answer(
        "‚úçÔ∏è <b>–¢–ï–ö–£–©–ò–ô –¢–ï–ö–°–¢ –ü–û–°–¢–ê</b>\n"
        "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∏–∂–µ ‚¨áÔ∏è, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ:",
        parse_mode="HTML"
    )

    # –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–ª–µ–≥–∫–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º)
    await callback.message.answer(draft.content)

    await callback.message.answer(
        "üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTML —Ä–∞–∑–º–µ—Ç–∫—É:\n"
        "<b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <code>–∫–æ–¥</code>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
        parse_mode="HTML"
    )


@router.callback_query(F.data.startswith("edit_llm:"))
async def callback_edit_llm(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ AI-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    await callback.answer()

    if not await check_admin(callback.from_user.id):
        await callback.message.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞")
        return

    draft_id = int(callback.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥—Ä–∞—Ñ—Ç
    result = await db.execute(
        select(PostDraft).where(PostDraft.id == draft_id)
    )
    draft = result.scalar_one_or_none()

    if not draft:
        await callback.answer("‚ùå –î—Ä–∞—Ñ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ state
    await state.update_data(
        draft_id=draft_id,
        original_content=draft.content,
        article_id=draft.article_id
    )
    await state.set_state(EditDraft.waiting_for_llm_edit)

    await callback.message.answer(
        f"<b>üìù –¢–µ–∫—É—â–∏–π –¥—Ä–∞—Ñ—Ç:</b>\n\n{draft.content}\n\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        f"ü§ñ <b>–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:</b>\n"
        f"–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        f"‚Ä¢ –°–¥–µ–ª–∞–π —Ç–æ–Ω –±–æ–ª–µ–µ –¥–µ–ª–æ–≤—ã–º\n"
        f"‚Ä¢ –£–±–µ—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏\n"
        f"‚Ä¢ –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n"
        f"‚Ä¢ –°–¥–µ–ª–∞–π –∫–æ—Ä–æ—á–µ, –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–º—ã—Å–ª–∞\n\n"
        f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
        parse_mode="HTML"
    )


@router.message(EditDraft.waiting_for_manual_edit, Command("cancel"))
@router.message(EditDraft.waiting_for_llm_edit, Command("cancel"))
async def cancel_edit(message: Message, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    await state.clear()
    await message.answer("‚ùå –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")


@router.message(EditDraft.waiting_for_manual_edit)
async def process_manual_edit(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä—É—á–Ω—É—é –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""
    data = await state.get_data()
    draft_id = data.get("draft_id")

    # –ü–æ–ª—É—á–∞–µ–º –¥—Ä–∞—Ñ—Ç
    result = await db.execute(
        select(PostDraft).where(PostDraft.id == draft_id)
    )
    draft = result.scalar_one_or_none()

    if not draft:
        await message.answer(f"‚ùå –î—Ä–∞—Ñ—Ç #{draft_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä–∞—Ñ—Ç –Ω–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º
    draft.content = message.text
    draft.status = 'edited'
    await db.commit()

    await message.answer(f"‚úÖ –î—Ä–∞—Ñ—Ç #{draft_id} –æ–±–Ω–æ–≤–ª–µ–Ω!")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥—Ä–∞—Ñ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
    await send_draft_for_review(message.chat.id, draft, db)

    await state.clear()


@router.message(EditDraft.waiting_for_llm_edit, F.voice)
async def process_voice_edit(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é."""
    await message.answer("üé§ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")

    try:
        # –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        voice_file = await get_bot().get_file(message.voice.file_id)
        voice_path = f"/tmp/voice_{message.voice.file_id}.ogg"
        await get_bot().download_file(voice_file.file_path, voice_path)

        # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Whisper API
        from openai import AsyncOpenAI
        from app.config import settings

        client = AsyncOpenAI(api_key=settings.openai_api_key)

        with open(voice_path, "rb") as audio_file:
            transcript = await client.audio.transcriptions.create(
                model="whisper-1",
                file=audio_file,
                language="ru"
            )

        edit_instructions = transcript.text

        await message.answer(
            f"‚úÖ <b>–†–∞—Å–ø–æ–∑–Ω–∞–ª:</b>\n<i>{edit_instructions}</i>\n\n‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç...",
            parse_mode="HTML"
        )

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        import os
        if os.path.exists(voice_path):
            os.remove(voice_path)

    except Exception as e:
        logger.error("voice_transcription_error", error=str(e))
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ –≥–æ–ª–æ—Å–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º"
        )
        return

    # –î–∞–ª–µ–µ —Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    data = await state.get_data()
    draft_id = data.get("draft_id")
    original_content = data.get("original_content")
    article_id = data.get("article_id")

    try:
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç—å—é
        result = await db.execute(
            select(RawArticle).where(RawArticle.id == article_id)
        )
        article = result.scalar_one_or_none()

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        llm = get_llm_provider(_selected_llm_provider)

        prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä Telegram-–ø–æ—Å—Ç–æ–≤ –æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö –≤ —Å—Ñ–µ—Ä–µ AI.

üìå –ò–°–•–û–î–ù–´–ô –ü–û–°–¢ (–∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):
{original_content}

üì∞ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–¨–Ø (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏):
{article.content[:1000] if article else '–ù–µ –¥–æ—Å—Ç—É–ø–Ω–∞'}

‚úèÔ∏è –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{edit_instructions}

üéØ –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¢–û–ß–ù–û –≤—ã–ø–æ–ª–Ω–∏ –∏—Ö. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è, —Ç–æ–ª—å–∫–æ —Ç–æ —á—Ç–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

–í–ê–ñ–ù–û:
1. –í—ã–ø–æ–ª–Ω–∏ –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö
2. –°–æ—Ö—Ä–∞–Ω–∏ –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Å—Ç–∞ (–∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ç–µ–∫—Å—Ç, —Ö–µ—à—Ç–µ–≥–∏)
3. –ò—Å–ø–æ–ª—å–∑—É–π HTML —Ä–∞–∑–º–µ—Ç–∫—É (<b>, <i>, <code>)
4. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—á–µ - —É–±–µ—Ä–∏ –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏
5. –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å - –¥–æ–±–∞–≤—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
6. –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–Ω - –∏–∑–º–µ–Ω–∏ —Å—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è
7. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç—å–∏

–í–ï–†–ù–ò –¢–û–õ–¨–ö–û –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π."""

        new_content = await llm.generate_completion(
            messages=[
                {"role": "system", "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3,
            max_tokens=3500
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤ state
        await state.update_data(new_content=new_content)

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
        from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å",
                    callback_data=f"publish_edited:{draft_id}"
                ),
                InlineKeyboardButton(
                    text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ",
                    callback_data=f"continue_edit:{draft_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",
                    callback_data=f"cancel_edit:{draft_id}"
                )
            ]
        ])

        await message.answer(
            f"<b>üìù –ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</b>\n\n{new_content}",
            reply_markup=keyboard,
            parse_mode="HTML"
        )

    except Exception as e:
        logger.error("voice_edit_generation_error", error=str(e), provider=_selected_llm_provider)
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel"
        )


@router.message(EditDraft.waiting_for_llm_edit)
async def process_edit(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —á–µ—Ä–µ–∑ LLM."""
    data = await state.get_data()
    draft_id = data.get("draft_id")
    original_content = data.get("original_content")
    article_id = data.get("article_id")
    edit_instructions = message.text

    await message.answer("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç...")

    try:
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç—å—é
        result = await db.execute(
            select(RawArticle).where(RawArticle.id == article_id)
        )
        article = result.scalar_one_or_none()

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä
        llm = get_llm_provider(_selected_llm_provider)

        prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä Telegram-–ø–æ—Å—Ç–æ–≤ –æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö –≤ —Å—Ñ–µ—Ä–µ AI.

üìå –ò–°–•–û–î–ù–´–ô –ü–û–°–¢ (–∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):
{original_content}

üì∞ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–¨–Ø (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏):
{article.content[:1000] if article else '–ù–µ –¥–æ—Å—Ç—É–ø–Ω–∞'}

‚úèÔ∏è –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{edit_instructions}

üéØ –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¢–û–ß–ù–û –≤—ã–ø–æ–ª–Ω–∏ –∏—Ö. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è, —Ç–æ–ª—å–∫–æ —Ç–æ —á—Ç–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

–í–ê–ñ–ù–û:
1. –í—ã–ø–æ–ª–Ω–∏ –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö
2. –°–æ—Ö—Ä–∞–Ω–∏ –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Å—Ç–∞ (–∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ç–µ–∫—Å—Ç, —Ö–µ—à—Ç–µ–≥–∏)
3. –ò—Å–ø–æ–ª—å–∑—É–π HTML —Ä–∞–∑–º–µ—Ç–∫—É (<b>, <i>, <code>)
4. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—á–µ - —É–±–µ—Ä–∏ –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏
5. –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å - –¥–æ–±–∞–≤—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
6. –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–Ω - –∏–∑–º–µ–Ω–∏ —Å—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è
7. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç—å–∏

–í–ï–†–ù–ò –¢–û–õ–¨–ö–û –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π."""

        new_content = await llm.generate_completion(
            messages=[
                {"role": "system", "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3,
            max_tokens=3500
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤ state
        await state.update_data(new_content=new_content)

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
        from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å",
                    callback_data=f"publish_edited:{draft_id}"
                ),
                InlineKeyboardButton(
                    text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ",
                    callback_data=f"continue_edit:{draft_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",
                    callback_data=f"cancel_edit:{draft_id}"
                )
            ]
        ])

        await message.answer(
            f"<b>üìù –ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</b>\n\n{new_content}",
            reply_markup=keyboard,
            parse_mode="HTML"
        )

    except Exception as e:
        logger.error("edit_generation_error", error=str(e), provider=_selected_llm_provider)
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel"
        )


@router.callback_query(F.data.startswith("publish_edited:"))
async def callback_publish_edited(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é."""
    # –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∞–ª–∞
    await callback.answer("–ü—É–±–ª–∏–∫—É—é...")

    if not await check_admin(callback.from_user.id):
        return

    draft_id = int(callback.data.split(":")[1])
    data = await state.get_data()
    new_content = data.get("new_content")

    # –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä–∞—Ñ—Ç
    result = await db.execute(
        select(PostDraft).where(PostDraft.id == draft_id)
    )
    draft = result.scalar_one_or_none()

    if draft and new_content:
        draft.content = new_content
        draft.status = 'edited'
        await db.commit()

        # –ü—É–±–ª–∏–∫—É–µ–º
        success = await publish_draft(draft_id, db, callback.from_user.id)

        try:
            if success:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (photo –∏–ª–∏ text)
                if callback.message.photo:
                    await callback.message.edit_caption(
                        caption=f"‚úÖ –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥—Ä–∞—Ñ—Ç #{draft_id} —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!",
                        reply_markup=None
                    )
                else:
                    await callback.message.edit_text(
                        text=f"‚úÖ –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥—Ä–∞—Ñ—Ç #{draft_id} —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!",
                        reply_markup=None
                    )
            else:
                if callback.message.photo:
                    await callback.message.edit_caption(
                        caption=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞—Ñ—Ç–∞ #{draft_id}",
                        reply_markup=None
                    )
                else:
                    await callback.message.edit_text(
                        text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞—Ñ—Ç–∞ #{draft_id}",
                        reply_markup=None
                    )
        except Exception as e:
            logger.error("callback_publish_edited_error", error=str(e), draft_id=draft_id)
            # Fallback - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
            status_msg = f"‚úÖ –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥—Ä–∞—Ñ—Ç #{draft_id} —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!" if success else f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞—Ñ—Ç–∞ #{draft_id}"
            await callback.message.answer(status_msg)
    else:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞: –¥—Ä–∞—Ñ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)

    await state.clear()


@router.callback_query(F.data.startswith("continue_edit:"))
async def callback_continue_edit(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    if not await check_admin(callback.from_user.id):
        return

    draft_id = int(callback.data.split(":")[1])
    data = await state.get_data()
    new_content = data.get("new_content")

    # –û–±–Ω–æ–≤–ª—è–µ–º original_content –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
    await state.update_data(original_content=new_content)

    text = (f"<b>üìù –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</b>\n\n{new_content}\n\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"‚úèÔ∏è <b>–û–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:</b>")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (photo –∏–ª–∏ text)
    if callback.message.photo:
        await callback.message.edit_caption(caption=text, parse_mode="HTML")
    else:
        await callback.message.edit_text(text, parse_mode="HTML")

    await callback.answer("–û–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è")


@router.callback_query(F.data.startswith("cancel_edit:"))
async def callback_cancel_edit(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    if not await check_admin(callback.from_user.id):
        return

    await state.clear()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (photo –∏–ª–∏ text)
    if callback.message.photo:
        await callback.message.edit_caption(caption="‚ùå –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await callback.message.edit_text("‚ùå –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

    await callback.answer("–û—Ç–º–µ–Ω–µ–Ω–æ")


@router.callback_query(F.data.startswith("cancel:"))
async def callback_cancel_action(callback: CallbackQuery, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–û—Ç–º–µ–Ω–∞' –≤ –¥–∏–∞–ª–æ–≥–∞—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (publish/reject)."""
    await callback.answer("–û—Ç–º–µ–Ω–µ–Ω–æ")

    if not await check_admin(callback.from_user.id):
        return

    draft_id = int(callback.data.split(":")[1])

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥—Ä–∞—Ñ—Ç–∞ (–æ—Ç–º–µ–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ)
    await callback.message.edit_reply_markup(
        reply_markup=get_draft_review_keyboard(draft_id)
    )


@router.callback_query(F.data.startswith("back_to_draft:"))
async def callback_back_to_draft(callback: CallbackQuery, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥' - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥—Ä–∞—Ñ—Ç–∞."""
    await callback.answer("–û—Ç–º–µ–Ω–µ–Ω–æ")

    if not await check_admin(callback.from_user.id):
        return

    draft_id = int(callback.data.split(":")[1])

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥—Ä–∞—Ñ—Ç–∞ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!)
    await callback.message.edit_reply_markup(
        reply_markup=get_draft_review_keyboard(draft_id)
    )


# ====================
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
# ====================

@router.callback_query(F.data == "show_drafts")
async def callback_show_drafts(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –¥—Ä–∞—Ñ—Ç—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    # –ü–æ–ª—É—á–∞–µ–º –í–°–ï –¥—Ä–∞—Ñ—Ç—ã –≤ —Å—Ç–∞—Ç—É—Å–µ pending_review (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ)
    result = await db.execute(
        select(PostDraft)
        .where(PostDraft.status == 'pending_review')
        .order_by(PostDraft.created_at.desc())
    )
    drafts = list(result.scalars().all())

    if not drafts:
        await callback.message.answer("üì≠ –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥—Ä–∞—Ñ—Ç–æ–≤ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏.")
        await callback.answer()
        return

    await callback.message.answer(f"üìù –ù–∞–π–¥–µ–Ω–æ {len(drafts)} –¥—Ä–∞—Ñ—Ç–æ–≤. –û—Ç–ø—Ä–∞–≤–ª—è—é...")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –¥—Ä–∞—Ñ—Ç (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π publisher_max_posts_per_day)
    max_drafts = min(len(drafts), settings.publisher_max_posts_per_day)
    for index, draft in enumerate(drafts[:max_drafts], start=1):
        await send_draft_for_review(callback.message.chat.id, draft, db, draft_number=index)

    await callback.answer("–î—Ä–∞—Ñ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã")


@router.callback_query(F.data == "run_fetch")
async def callback_run_fetch(callback: CallbackQuery):
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    await callback.message.answer("üîÑ –ó–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π...")

    try:
        from app.tasks.celery_tasks import manual_workflow
        task = manual_workflow.delay()

        await callback.message.answer(
            f"‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞!\n"
            f"ID –∑–∞–¥–∞—á–∏: <code>{task.id}</code>\n\n"
            f"–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º–µ—Ç 5-10 –º–∏–Ω—É—Ç.\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /drafts —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –¥—Ä–∞—Ñ—Ç—ã.",
            parse_mode="HTML"
        )
        await callback.answer("–°–±–æ—Ä –∑–∞–ø—É—â–µ–Ω")
    except Exception as e:
        logger.error("fetch_error", error=str(e))
        await callback.message.answer(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {str(e)}")
        await callback.answer("–û—à–∏–±–∫–∞", show_alert=True)


@router.callback_query(F.data == "show_stats")
async def callback_show_stats(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    stats_text = await get_statistics(db)
    await callback.message.answer(stats_text, parse_mode="HTML")
    await callback.answer()


@router.callback_query(F.data == "show_settings")
async def callback_show_settings(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õîÔ∏è –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üì∞ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="settings:sources")],
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª–∏ LLM", callback_data="settings:llm")],
        [InlineKeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (DALL-E)", callback_data="settings:dalle")],
        [InlineKeyboardButton(text="üìÖ –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è", callback_data="settings:autopublish")],
        [InlineKeyboardButton(text="üîÑ –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="settings:fetcher")],
        [InlineKeyboardButton(text="üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", callback_data="settings:alerts")],
        [InlineKeyboardButton(text="üéØ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ", callback_data="settings:quality")],
        [InlineKeyboardButton(text="üí∞ –ë—é–¥–∂–µ—Ç API", callback_data="settings:budget")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_main_menu")],
    ])

    await callback.message.edit_text(
        "‚öôÔ∏è <b>–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
        "–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "show_llm_selection")
async def callback_show_llm_selection(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."""
    await callback.answer()

    if not await check_admin(callback.from_user.id):
        return

    await callback.message.answer(
        "ü§ñ <b>–í—ã–±–µ—Ä–∏—Ç–µ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:</b>\n\n"
        "‚Ä¢ <b>OpenAI</b> - GPT-4o-mini –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞\n"
        "‚Ä¢ <b>Perplexity</b> - Llama 3.1 —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
        "‚Ä¢ <b>DeepSeek</b> - DeepSeek V3 (—Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)",
        parse_mode="HTML",
        reply_markup=get_llm_selection_keyboard(_selected_llm_provider)
    )




# ====================
# –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# ====================

async def send_draft_for_review(chat_id: int, draft: PostDraft, db: AsyncSession, bot=None, draft_number: int = None):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä–∞—Ñ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.

    Args:
        chat_id: ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        draft: –î—Ä–∞—Ñ—Ç –ø–æ—Å—Ç–∞
        db: –°–µ—Å—Å–∏—è –ë–î
        bot: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Bot (–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Celery tasks)
        draft_number: –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –¥—Ä–∞—Ñ—Ç–∞ –∑–∞ –¥–µ–Ω—å (–µ—Å–ª–∏ None, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è draft.id)
    """
    try:
        if bot is None:
            bot = get_bot()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç—å–µ
        result = await db.execute(
            select(RawArticle).where(RawArticle.id == draft.article_id)
        )
        article = result.scalar_one_or_none()

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ ID
        display_number = draft_number if draft_number is not None else draft.id

        # –§–æ—Ä–º–∏—Ä—É–µ–º preview —Ç–µ–∫—Å—Ç
        preview_header = f"üÜï <b>–ù–æ–≤—ã–π –¥—Ä–∞—Ñ—Ç #{display_number}</b>"

        preview_footer = f"""
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Confidence: {draft.confidence_score:.2f}
üîó –ò—Å—Ç–æ—á–Ω–∏–∫: {article.source_name if article else 'Unknown'}
‚è∞ –°–æ–∑–¥–∞–Ω: {draft.created_at.strftime('%d.%m.%Y %H:%M')}
"""

        full_preview_text = f"{preview_header}\n\n{draft.content}\n{preview_footer}"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å
        if draft.image_path:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–≤—É–º—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –ª–∏–º–∏—Ç–∞ caption (1024 —Å–∏–º–≤–æ–ª–∞)
            photo = FSInputFile(draft.image_path)
            await bot.send_photo(
                chat_id=chat_id,
                photo=photo,
                caption=preview_header
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç preview —Å –∫–Ω–æ–ø–∫–∞–º–∏
            await bot.send_message(
                chat_id=chat_id,
                text=f"{draft.content}\n{preview_footer}",
                reply_markup=get_draft_review_keyboard(draft.id),
                parse_mode="HTML"
            )
        else:
            await bot.send_message(
                chat_id=chat_id,
                text=full_preview_text,
                reply_markup=get_draft_review_keyboard(draft.id),
                parse_mode="HTML"
            )

        logger.info("draft_sent_for_review", draft_id=draft.id)

    except Exception as e:
        logger.error("draft_send_error", draft_id=draft.id, error=str(e))


async def _vectorize_publication_background(pub_id: int, content: str, draft_id: int):
    """–§–æ–Ω–æ–≤–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Qdrant (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI)."""
    try:
        vector_search = get_vector_search()
        await vector_search.add_publication(
            pub_id=pub_id,
            content=content,
            published_at=datetime.utcnow(),
            reactions={}
        )
        logger.info("publication_vectorized", pub_id=pub_id, draft_id=draft_id)
    except Exception as vec_error:
        logger.warning(
            "vectorization_failed",
            draft_id=draft_id,
            error=str(vec_error)
        )


async def publish_draft(draft_id: int, db: AsyncSession, admin_id: int) -> bool:
    """
    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –¥—Ä–∞—Ñ—Ç –≤ –∫–∞–Ω–∞–ª.

    Args:
        draft_id: ID –¥—Ä–∞—Ñ—Ç–∞
        db: –°–µ—Å—Å–∏—è –ë–î
        admin_id: ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

    Returns:
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, False –∏–Ω–∞—á–µ
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥—Ä–∞—Ñ—Ç
        result = await db.execute(
            select(PostDraft).where(PostDraft.id == draft_id)
        )
        draft = result.scalar_one_or_none()

        if not draft:
            return False

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç—å—é –¥–ª—è —Å—Å—ã–ª–∫–∏
        result = await db.execute(
            select(RawArticle).where(RawArticle.id == draft.article_id)
        )
        article = result.scalar_one_or_none()

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
        final_text = draft.content
        logger.info("publish_draft_before_title_removal", draft_id=draft_id, has_image=bool(draft.image_path), title=draft.title[:50] if draft.title else None, content_start=final_text[:100])

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - —É–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–æ–Ω —É–∂–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ)
        if draft.image_path and draft.title:
            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –º–∞—Ä–∫–µ—Ä—ã –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
            intl_markers = ["üåç –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏:\n\n", "üåé –ó–∞ —Ä—É–±–µ–∂–æ–º:\n\n", "üåè –í –º–∏—Ä–µ:\n\n",
                           "üåê –ù–æ–≤–æ—Å—Ç–∏ –∏–∑-–∑–∞ —Ä—É–±–µ–∂–∞:\n\n", "üó∫Ô∏è –ó–∞—Ä—É–±–µ–∂–Ω—ã–π –æ–ø—ã—Ç:\n\n"]

            intl_prefix = ""
            for marker in intl_markers:
                if final_text.startswith(marker):
                    intl_prefix = marker
                    final_text = final_text[len(marker):]  # –í—Ä–µ–º–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä
                    break

            # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–±—ã—á–Ω–æ –≤ –Ω–∞—á–∞–ª–µ –≤ —Ç–µ–≥–∞—Ö <b>...</b>)
            title_patterns = [
                f"<b>{draft.title}</b>\n\n",
                f"<b>{draft.title}</b>\n",
                f"{draft.title}\n\n",
                f"{draft.title}\n"
            ]
            for pattern in title_patterns:
                if final_text.startswith(pattern):
                    logger.info("publish_draft_title_pattern_matched", draft_id=draft_id, pattern=pattern[:50])
                    final_text = final_text[len(pattern):]
                    break

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Ä–∫–µ—Ä –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –µ—Å–ª–∏ –±—ã–ª
            final_text = intl_prefix + final_text

            logger.info("publish_draft_after_title_removal", draft_id=draft_id, content_start=final_text[:100])

        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∏ –∏—Å—Ç–æ—á–Ω–∏–∫
        if article:
            final_text += f"\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # –ò—Å—Ç–æ—á–Ω–∏–∫ —Å attribution
            source_name = article.source_name if article.source_name else "–ò—Å—Ç–æ—á–Ω–∏–∫"
            final_text += f"\nüì∞ {source_name}"

        # –ü—É–±–ª–∏–∫—É–µ–º –≤ –∫–∞–Ω–∞–ª
        if draft.image_path:
            # –ü—É–±–ª–∏–∫—É–µ–º –¥–≤—É–º—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –ª–∏–º–∏—Ç–∞ caption (1024 —Å–∏–º–≤–æ–ª–∞)
            # 1. –§–æ—Ç–æ –ë–ï–ó –ø–æ–¥–ø–∏—Å–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–∂–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏)
            photo = FSInputFile(draft.image_path)
            photo_message = await get_bot().send_photo(
                chat_id=settings.telegram_channel_id,
                photo=photo
            )

            # 2. –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ (–¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤)
            text = final_text[:4096] if len(final_text) > 4096 else final_text
            message = await get_bot().send_message(
                chat_id=settings.telegram_channel_id,
                text=text,
                parse_mode="HTML",
                reply_markup=get_reader_keyboard(
                    article.url,
                    post_id=draft.id
                ) if article else None
            )
        else:
            # Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç text –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤
            text = final_text[:4096] if len(final_text) > 4096 else final_text
            message = await get_bot().send_message(
                chat_id=settings.telegram_channel_id,
                text=text,
                parse_mode="HTML",
                reply_markup=get_reader_keyboard(
                    article.url,
                    post_id=draft.id
                ) if article else None
            )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é –≤ –ë–î
        publication = Publication(
            draft_id=draft.id,
            message_id=message.message_id,
            channel_id=settings.telegram_channel_id_numeric,
        )
        db.add(publication)

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥—Ä–∞—Ñ—Ç–∞
        draft.status = 'approved'
        draft.reviewed_at = datetime.utcnow()
        draft.reviewed_by = admin_id

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º feedback
        feedback = FeedbackLabel(
            draft_id=draft.id,
            admin_action='published'
        )
        db.add(feedback)

        await db.commit()
        await db.refresh(publication)

        # –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Celery (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI)
        if settings.qdrant_enabled:
            try:
                from app.tasks.celery_tasks import vectorize_publication_task
                vectorize_publication_task.delay(
                    pub_id=publication.id,
                    content=draft.content,
                    draft_id=draft.id
                )
                logger.info("vectorization_task_queued", pub_id=publication.id, draft_id=draft.id)
            except Exception as e:
                logger.warning("vectorization_task_queue_error", error=str(e))

        logger.info(
            "draft_published",
            draft_id=draft.id,
            message_id=message.message_id
        )

        return True

    except Exception as e:
        logger.error("publish_error", draft_id=draft_id, error=str(e))
        return False


async def reject_draft(
    draft_id: int,
    reason: str,
    db: AsyncSession,
    admin_id: int
) -> bool:
    """
    –û—Ç–∫–ª–æ–Ω–∏—Ç—å –¥—Ä–∞—Ñ—Ç.

    Args:
        draft_id: ID –¥—Ä–∞—Ñ—Ç–∞
        reason: –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
        db: –°–µ—Å—Å–∏—è –ë–î
        admin_id: ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

    Returns:
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, False –∏–Ω–∞—á–µ
    """
    try:
        result = await db.execute(
            select(PostDraft).where(PostDraft.id == draft_id)
        )
        draft = result.scalar_one_or_none()

        if not draft:
            return False

        draft.status = 'rejected'
        draft.rejection_reason = reason
        draft.reviewed_at = datetime.utcnow()
        draft.reviewed_by = admin_id

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º feedback
        feedback = FeedbackLabel(
            draft_id=draft.id,
            admin_action='rejected',
            rejection_reason=reason
        )
        db.add(feedback)

        await db.commit()

        logger.info("draft_rejected", draft_id=draft.id, reason=reason)

        return True

    except Exception as e:
        logger.error("reject_error", draft_id=draft_id, error=str(e))
        return False


@router.callback_query(F.data.startswith("opinion:"))
async def callback_opinion(callback: CallbackQuery, db: AsyncSession):
    """
    –ü–æ–∫–∞–∑–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–Ω–µ–Ω–∏—è –æ –ø–æ—Å—Ç–µ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥ –ø–æ—Å—Ç–æ–º).
    """
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º post_id –∏–∑ callback_data
        post_id = int(callback.data.split(":")[1])

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥ –ø–æ—Å—Ç–æ–º (–Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!)
        await callback.message.edit_reply_markup(
            reply_markup=get_opinion_keyboard(post_id)
        )

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω–µ alert, –ø—Ä–æ—Å—Ç–æ —Ç–æ—Å—Ç)
        await callback.answer("üìä –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–µ–∞–∫—Ü–∏—é ‚¨áÔ∏è")

    except Exception as e:
        logger.error("opinion_callback_error", error=str(e))
        await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", show_alert=True)


@router.callback_query(F.data.startswith("react:"))
async def callback_react(callback: CallbackQuery, db: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–æ—Å—Ç.
    """
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ callback_data: react:post_id:reaction_type
        parts = callback.data.split(":")
        if len(parts) != 3:
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
            return
            
        post_id = int(parts[1])
        reaction_type = parts[2]
        
        logger.info("callback_react_started", callback_data=callback.data)
        
        # –ü–æ–∏—Å–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        result = await db.execute(
            select(Publication)
            .join(PostDraft)
            .where(PostDraft.id == post_id)
        )
        publication = result.scalar_one_or_none()
        
        if not publication:
            logger.warning("publication_not_found", post_id=post_id)
            await callback.answer("‚ùå –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏
        current_reactions = publication.reactions or {}
        current_count = current_reactions.get(reaction_type, 0)
        current_reactions[reaction_type] = current_count + 1
        publication.reactions = current_reactions
        
        await db.commit()
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        reactions = publication.reactions or {}
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏
        reaction_emoji = {
            "useful": "üëç",
            "important": "üî•",
            "controversial": "ü§î",
            "banal": "üí§",
            "obvious": "ü§∑",
            "poor_quality": "üëé",
            "low_content_quality": "üìâ",
            "bad_source": "üì∞"
        }
        
        reaction_text = {
            "useful": "–ü–æ–ª–µ–∑–Ω–æ",
            "important": "–í–∞–∂–Ω–æ",
            "controversial": "–°–ø–æ—Ä–Ω–æ",
            "banal": "–ë–∞–Ω–∞–ª—å–Ω–æ",
            "obvious": "–û—á–µ–≤–∏–¥–Ω–æ",
            "poor_quality": "–ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ",
            "low_content_quality": "–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞",
            "bad_source": "–ü–ª–æ—Ö–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫"
        }
        
        reaction_lines = []
        for reaction, emoji in reaction_emoji.items():
            count = reactions.get(reaction, 0)
            if count > 0:
                text = reaction_text.get(reaction, reaction)
                reaction_lines.append(f"{emoji} {text}: {count}")
        
        reaction_summary = "\n".join(reaction_lines) if reaction_lines else "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–π"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        await callback.answer(f"‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è —É—á—Ç–µ–Ω–∞.\n\nüìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n{reaction_summary}", show_alert=True)

        # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü–∏–π, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ (–ë–ï–ó –∫–Ω–æ–ø–∫–∏ "–í–∞—à–µ –º–Ω–µ–Ω–∏–µ")
        try:
            # –ü–æ–ª—É—á–∞–µ–º draft –∏ article –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            draft_result = await db.execute(
                select(PostDraft).where(PostDraft.id == post_id)
            )
            draft = draft_result.scalar_one_or_none()

            article_url = ""
            if draft and draft.article_id:
                article_result = await db.execute(
                    select(RawArticle).where(RawArticle.id == draft.article_id)
                )
                article = article_result.scalar_one_or_none()
                if article:
                    article_url = article.url

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ë–ï–ó –∫–Ω–æ–ø–∫–∏ "–í–∞—à–µ –º–Ω–µ–Ω–∏–µ" (post_id=None —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É)
            await callback.message.edit_reply_markup(
                reply_markup=get_reader_keyboard(article_url, post_id=None)
            )
        except Exception as edit_error:
            logger.error("keyboard_restore_error", error=str(edit_error))

        logger.info("reaction_processed", post_id=post_id, reaction_type=reaction_type, total_reactions=sum(reactions.values()))

    except Exception as e:
        logger.error("react_callback_error", error=str(e))
        await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∞–∫—Ü–∏–∏", show_alert=True)
    pending_count = await db.scalar(
        select(func.count(PostDraft.id)).where(PostDraft.status == 'pending_review')
    )

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–∏—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
    personal_posts_count = await db.scalar(select(func.count(PersonalPost.id)))
    personal_published_count = await db.scalar(
        select(func.count(PersonalPost.id)).where(PersonalPost.published == True)
    )

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ views/reactions –¥–ª—è –ª–∏—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
    personal_views_sum = await db.scalar(
        select(func.sum(PersonalPost.views_count)).where(PersonalPost.published == True)
    ) or 0
    personal_reactions_sum = await db.scalar(
        select(func.sum(PersonalPost.reactions_count)).where(PersonalPost.published == True)
    ) or 0

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å API –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    api_cost_data = await get_current_month_cost(db)

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É AI –∞–Ω–∞–ª–∏–∑–∞
    analytics = AnalyticsService(db)
    ai_stats = await analytics.get_ai_analysis_stats()

    stats_text = f"""
üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</b>

üì∞ –í—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π: {articles_count}
üìù –í—Å–µ–≥–æ –¥—Ä–∞—Ñ—Ç–æ–≤: {drafts_count}
‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {publications_count}
‚è≥ –û–∂–∏–¥–∞—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {pending_count}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úçÔ∏è <b>–õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</b>

üìî –í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫: {personal_posts_count}
üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {personal_published_count}
üëÅ –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {personal_views_sum:,}
üëç –í—Å–µ–≥–æ —Ä–µ–∞–∫—Ü–∏–π: {personal_reactions_sum}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å API –∑–∞ {api_cost_data['month_name']}</b>

üíµ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${api_cost_data['total_cost_usd']:.4f}
üìä –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: {api_cost_data['total_tokens']:,}
üî¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {api_cost_data['total_requests']}
"""

    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
    if api_cost_data['by_provider']:
        stats_text += "\n<b>–ü–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º:</b>\n"
        for provider, data in api_cost_data['by_provider'].items():
            provider_name = "OpenAI" if provider == "openai" else "Perplexity"
            stats_text += f"‚îú‚îÄ {provider_name}:\n"
            stats_text += f"‚îÇ  ‚îú‚îÄ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${data['cost_usd']:.4f}\n"
            stats_text += f"‚îÇ  ‚îú‚îÄ –¢–æ–∫–µ–Ω–æ–≤: {data['tokens']:,}\n"
            stats_text += f"‚îÇ  ‚îî‚îÄ –ó–∞–ø—Ä–æ—Å–æ–≤: {data['requests']}\n"

    # –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞ Perplexity
    stats_text += "\nüîó <a href='https://www.perplexity.ai/account/api/billing'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å Perplexity API</a>\n"

    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É AI –∞–Ω–∞–ª–∏–∑–∞
    stats_text += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
    stats_text += "ü§ñ <b>AI –ê–Ω–∞–ª–∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</b>\n\n"

    if ai_stats['month']['count'] > 0 or ai_stats['year']['count'] > 0:
        stats_text += f"<b>–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:</b>\n"
        stats_text += f"‚îú‚îÄ –ó–∞–ø—Ä–æ—Å–æ–≤: {ai_stats['month']['count']}\n"
        stats_text += f"‚îú‚îÄ –¢–æ–∫–µ–Ω–æ–≤: {ai_stats['month']['total_tokens']:,}\n"
        stats_text += f"‚îî‚îÄ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${ai_stats['month']['total_cost_usd']:.4f}\n"

        # –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º –∑–∞ –º–µ—Å—è—Ü
        if ai_stats['month']['by_model']:
            for model, data in ai_stats['month']['by_model'].items():
                model_name = model.replace('gpt-', 'GPT-').upper()
                stats_text += f"   ‚îî‚îÄ {model_name}: {data['count']} –∑–∞–ø—Ä–æ—Å–æ–≤, ${data['cost_usd']:.4f}\n"

        stats_text += f"\n<b>–ó–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥:</b>\n"
        stats_text += f"‚îú‚îÄ –ó–∞–ø—Ä–æ—Å–æ–≤: {ai_stats['year']['count']}\n"
        stats_text += f"‚îú‚îÄ –¢–æ–∫–µ–Ω–æ–≤: {ai_stats['year']['total_tokens']:,}\n"
        stats_text += f"‚îî‚îÄ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${ai_stats['year']['total_cost_usd']:.2f}\n"

        # –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º –∑–∞ –≥–æ–¥
        if ai_stats['year']['by_model']:
            for model, data in ai_stats['year']['by_model'].items():
                model_name = model.replace('gpt-', 'GPT-').upper()
                stats_text += f"   ‚îî‚îÄ {model_name}: {data['count']} –∑–∞–ø—Ä–æ—Å–æ–≤, ${data['cost_usd']:.2f}\n"
    else:
        stats_text += "–ê–Ω–∞–ª–∏–∑—ã –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å\n"

    stats_text += f"\nüìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"

    return stats_text


# ====================
# Analytics Dashboard
# ====================

def format_analytics_report(
    stats: Dict,
    top_posts: List[Dict],
    worst_posts: List[Dict],
    sources: List[Dict],
    weekday_stats: Dict,
    vector_stats: Optional[Dict],
    source_recommendations: Optional[List[Dict]] = None,
    views_stats: Optional[Dict] = None,
    best_time: Optional[Dict] = None,
    trending_topics: Optional[List[Dict]] = None,
    alerts: Optional[List[Dict]] = None
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á—ë—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

    Args:
        stats: –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        top_posts: –¢–æ–ø –ø–æ—Å—Ç–æ–≤
        worst_posts: –•—É–¥—à–∏–µ –ø–æ—Å—Ç—ã
        sources: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        weekday_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
        vector_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã

    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞
    """
    period_days = stats.get("period_days", 7)

    report = f"""üìä <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞ @legal_ai_pro</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìà <b>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {period_days} –¥–Ω–µ–π:</b>

<b>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏:</b>
‚îú‚îÄ üìù –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {stats['total_publications']} –ø–æ—Å—Ç–æ–≤
‚îú‚îÄ ‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: {stats['approved_drafts']} –∏–∑ {stats['total_drafts']} –¥—Ä–∞—Ñ—Ç–æ–≤ ({stats['approval_rate']:.0f}%)
‚îú‚îÄ ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: {stats['rejected_drafts']} –¥—Ä–∞—Ñ—Ç–æ–≤
‚îî‚îÄ üìä Avg quality score: {stats['avg_quality_score']}

<b>–†–µ–∞–∫—Ü–∏–∏:</b>
‚îú‚îÄ üëç –ü–æ–ª–µ–∑–Ω–æ: {stats['reactions']['useful']} ({stats['reactions']['useful']/max(stats['total_reactions'],1)*100:.0f}%)
‚îú‚îÄ üî• –í–∞–∂–Ω–æ: {stats['reactions']['important']} ({stats['reactions']['important']/max(stats['total_reactions'],1)*100:.0f}%)
‚îú‚îÄ ü§î –°–ø–æ—Ä–Ω–æ: {stats['reactions']['controversial']} ({stats['reactions']['controversial']/max(stats['total_reactions'],1)*100:.0f}%)
‚îú‚îÄ üí§ –ë–∞–Ω–∞–ª—å—â–∏–Ω–∞: {stats['reactions']['banal']} ({stats['reactions']['banal']/max(stats['total_reactions'],1)*100:.0f}%)
‚îú‚îÄ ü§∑ –û—á–µ–≤–∏–¥–Ω–æ: {stats['reactions']['obvious']} ({stats['reactions']['obvious']/max(stats['total_reactions'],1)*100:.0f}%)
‚îú‚îÄ üëé –ü–ª–æ—Ö–æ–µ: {stats['reactions']['poor_quality']} ({stats['reactions']['poor_quality']/max(stats['total_reactions'],1)*100:.0f}%)
‚îú‚îÄ üìâ –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ: {stats['reactions']['low_content_quality']} ({stats['reactions']['low_content_quality']/max(stats['total_reactions'],1)*100:.0f}%)
‚îî‚îÄ üì∞ –ü–ª–æ—Ö–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫: {stats['reactions']['bad_source']} ({stats['reactions']['bad_source']/max(stats['total_reactions'],1)*100:.0f}%)

<b>Engagement:</b>
‚îú‚îÄ üìä –í—Å–µ–≥–æ —Ä–µ–∞–∫—Ü–∏–π: {stats['total_reactions']}
‚îú‚îÄ üí¨ –ü–æ—Å—Ç–æ–≤ —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏: {stats['engaged_publications']} –∏–∑ {stats['total_publications']}
‚îî‚îÄ üéØ Engagement rate: {stats['engagement_rate']}%
"""

    # –¢–æ–ø –ø–æ—Å—Ç—ã
    if top_posts:
        report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "üî• <b>–¢–æ–ø-3 –ø–æ—Å—Ç–∞:</b>\n\n"

        for i, post in enumerate(top_posts[:3], 1):
            title_raw = post['title'][:80] + "..." if len(post['title']) > 80 else post['title']
            title = html.escape(title_raw)
            date = post['published_at'].strftime('%d.%m.%Y %H:%M')
            reactions = post['reactions']

            report += f"{i}Ô∏è‚É£ <b>{title}</b>\n"
            report += f"   üìÖ {date}\n"
            report += f"   üëç {reactions.get('useful', 0)} | üî• {reactions.get('important', 0)} | ü§î {reactions.get('controversial', 0)}\n"
            report += f"   üìä Quality: {post['quality_score']}\n"
            if post['telegram_message_id']:
                msg_id = post['telegram_message_id']
                report += f'   üîó <a href="https://t.me/legal_ai_pro/{msg_id}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç—É</a>\n'
            report += "\n"

    # –•—É–¥—à–∏–µ –ø–æ—Å—Ç—ã
    if worst_posts:
        report += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "üí§ <b>–•—É–¥—à–∏–µ –ø–æ—Å—Ç—ã (—É—á–∏–º—Å—è –Ω–∞ –æ—à–∏–±–∫–∞—Ö):</b>\n\n"

        for i, post in enumerate(worst_posts[:3], 1):
            title_raw = post['title'][:80] + "..." if len(post['title']) > 80 else post['title']
            title = html.escape(title_raw)
            date = post['published_at'].strftime('%d.%m.%Y %H:%M')
            reactions = post['reactions']

            report += f"{i}Ô∏è‚É£ <b>{title}</b>\n"
            report += f"   üìÖ {date}\n"
            report += f"   üí§ {reactions.get('banal', 0)} | üëé {reactions.get('poor_quality', 0)} | ü§∑ {reactions.get('obvious', 0)}\n"
            report += f"   üìä Quality: {post['quality_score']}\n"

            # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É
            if reactions.get('banal', 0) > 0:
                report += "   ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º –æ–±—â–æ, –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏\n"
            elif reactions.get('obvious', 0) > 0:
                report += "   ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –û—á–µ–≤–∏–¥–Ω—ã–µ –≤—ã–≤–æ–¥—ã\n"
            elif reactions.get('poor_quality', 0) > 0:
                report += "   ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n"
            elif reactions.get('low_content_quality', 0) > 0:
                report += "   ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–æ—Ö–∞—è –ø–æ–¥–∞—á–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞\n"
            elif reactions.get('bad_source', 0) > 0:
                report += "   ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–Ω–∞–¥–µ–∂–Ω—ã–π –∏–ª–∏ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫\n"

            report += "\n"

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
    if weekday_stats:
        report += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "üìÖ <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:</b>\n\n"

        best_day = None
        best_score = -999.0

        for day in ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]:
            if day in weekday_stats:
                day_data = weekday_stats[day]
                total = day_data['total_posts']
                avg_score = day_data['avg_quality_score']

                if avg_score > best_score:
                    best_score = avg_score
                    best_day = day

                marker = "‚≠ê" if day == best_day and total > 0 else ""
                report += f"{day}: {total} –ø–æ—Å—Ç–æ–≤ | Avg quality: {avg_score} {marker}\n"

        if best_day:
            report += f"\nüèÜ –õ—É—á—à–∏–π –¥–µ–Ω—å: <b>{best_day}</b> (avg quality: {best_score})\n"

    # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    if sources:
        report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "üì∞ <b>–¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:</b>\n\n"

        for i, source in enumerate(sources[:5], 1):
            name_raw = source['source_name'][:40] + "..." if len(source['source_name']) > 40 else source['source_name']
            name = html.escape(name_raw)
            collected = source['total_collected']
            published = source['total_published']
            pub_rate = source['publication_rate']
            quality = source['avg_quality_score']

            status = ""
            if quality >= 0.6:
                status = "‚úÖ"
            elif quality >= 0.3:
                status = "‚ö†Ô∏è"
            else:
                status = "‚ùå"

            report += f"{i}. <b>{name}</b> {status}\n"
            report += f"   ‚îú‚îÄ –û—Ç–æ–±—Ä–∞–Ω–æ: {collected} –Ω–æ–≤–æ—Å—Ç–µ–π\n"
            report += f"   ‚îú‚îÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {published} ({pub_rate:.0f}%)\n"
            report += f"   ‚îî‚îÄ Avg quality: {quality}\n"
            report += "\n"

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã
    if vector_stats:
        report += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "üóÑÔ∏è <b>–í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ Qdrant:</b>\n\n"
        report += f"‚îú‚îÄ üì¶ –í—Å–µ–≥–æ –≤–µ–∫—Ç–æ—Ä–æ–≤: {vector_stats['total_vectors']}\n"
        report += f"‚îú‚îÄ ‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤: {vector_stats['positive_examples']} (score &gt; 0.5)\n"
        report += f"‚îú‚îÄ ‚ùå –ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤: {vector_stats['negative_examples']} (score &lt; -0.3)\n"
        report += f"‚îú‚îÄ ‚öñÔ∏è –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö: {vector_stats['neutral_examples']}\n"
        report += f"‚îî‚îÄ üìä Avg score –≤—Å–µ–π –±–∞–∑—ã: {vector_stats['avg_quality_score']}\n"

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
    if source_recommendations:
        report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "‚ö° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º:</b>\n\n"

        for rec in source_recommendations[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5
            source_name_escaped = html.escape(rec["source_name"])
            report += f"<b>{source_name_escaped}</b>\n"
            report += f"   {rec['recommendation']}\n"
            report += f"   ‚îú‚îÄ –ü—É–±–ª–∏–∫–∞—Ü–∏–π: {rec['total_publications']}\n"
            report += f"   ‚îú‚îÄ Avg quality: {rec['avg_quality_score']}\n"
            report += f"   ‚îú‚îÄ –†–µ–∞–∫—Ü–∏–π '–ü–ª–æ—Ö–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫': {rec['bad_source_reactions']}\n"
            report += f"   ‚îî‚îÄ –†–µ–∞–∫—Ü–∏–π '–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ': {rec['low_quality_reactions']}\n"
            report += "\n"

        if not source_recommendations:
            report += "‚úÖ –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Ö–æ—Ä–æ—à–æ!\n"

    # Views –∏ Forwards —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    # –ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ —Ñ–æ—Ä–≤–∞—Ä–¥—ã (Telegram metrics)
    report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    report += "üìà <b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ –§–æ—Ä–≤–∞—Ä–¥—ã:</b>\n\n"

    if views_stats and views_stats.get('total_views', 0) > 0:
        report += f"‚îú‚îÄ üëÅÔ∏è –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {views_stats['total_views']:,}\n"
        report += f"‚îú‚îÄ üì§ –í—Å–µ–≥–æ —Ñ–æ—Ä–≤–∞—Ä–¥–æ–≤: {views_stats['total_forwards']:,}\n"
        report += f"‚îú‚îÄ üìä Avg –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤/–ø–æ—Å—Ç: {views_stats['avg_views']}\n"
        report += f"‚îú‚îÄ üìä Avg —Ñ–æ—Ä–≤–∞—Ä–¥–æ–≤/–ø–æ—Å—Ç: {views_stats['avg_forwards']}\n"
        report += f"‚îú‚îÄ üî• –ú–∞–∫—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {views_stats['max_views']:,}\n"
        report += f"‚îú‚îÄ üî• –ú–∞–∫—Å —Ñ–æ—Ä–≤–∞—Ä–¥–æ–≤: {views_stats['max_forwards']:,}\n"
        report += f"‚îî‚îÄ üåä Viral coefficient: {views_stats['viral_coefficient']}%\n"
    else:
        report += "‚ö†Ô∏è <b>–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</b>\n"
        report += "‚îú‚îÄ –ú–µ—Ç—Ä–∏–∫–∏ –∏–∑ Telegram –µ—â–µ –Ω–µ —Å–æ–±—Ä–∞–Ω—ã\n"
        report += "‚îú‚îÄ Celery –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤\n"
        report += "‚îú‚îÄ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: 00:00 / 06:00 / 12:00 / 18:00 MSK\n"
        report += "‚îî‚îÄ –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker compose logs celery_worker | grep collect_telegram_metrics\n"

    # A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    report += "‚è∞ <b>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</b>\n\n"

    if best_time and best_time.get('best_hour') is not None:
        report += f"üéØ {best_time['recommendation']}\n"
        report += f"‚îú‚îÄ Engagement rate: {best_time['best_engagement_rate']}%\n"
        report += f"‚îî‚îÄ –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞ 30 –¥–Ω–µ–π\n"
    else:
        report += "‚ö†Ô∏è <b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</b>\n"
        report += "‚îî‚îÄ –¢—Ä–µ–±—É–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã 1 –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å views –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\n"

    # –¢—Ä–µ–Ω–¥–æ–≤—ã–µ —Ç–µ–º—ã
    report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    report += "üî• <b>–¢—Ä–µ–Ω–¥–æ–≤—ã–µ —Ç–µ–º—ã:</b>\n\n"

    if trending_topics:
        for i, topic in enumerate(trending_topics[:5], 1):
            report += f"{i}. <b>{topic['topic']}</b>\n"
            report += f"   ‚îú‚îÄ –£–ø–æ–º–∏–Ω–∞–Ω–∏–π: {topic['mentions']}\n"
            report += f"   ‚îî‚îÄ Relevance: {topic['relevance_score']}%\n"
    else:
        report += "‚ö†Ô∏è <b>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</b>\n"
        report += "‚îî‚îÄ –¢—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º\n"

    # –ê–ª–µ—Ä—Ç—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if alerts:
        report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        report += "üö® <b>–ê–ª–µ—Ä—Ç—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</b>\n\n"
        for alert in alerts:
            report += f"{alert['message']}\n"
            report += f"   ‚îî‚îÄ {alert['details']}\n\n"

    report += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    report += f"üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"

    return report


@router.message(Command("analytics"))
async def cmd_analytics(message: Message, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∫–∞–Ω–∞–ª–∞."""

    if not await check_admin(message.from_user.id):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
        return

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üìÖ 7 –¥–Ω–µ–π", callback_data="analytics:7"),
            InlineKeyboardButton(text="üìÖ 30 –¥–Ω–µ–π", callback_data="analytics:30"),
        ],
        [
            InlineKeyboardButton(text="üìÖ –í—Å—ë –≤—Ä–µ–º—è", callback_data="analytics:all"),
        ],
        [
            InlineKeyboardButton(text="ü§ñ AI –ê–Ω–∞–ª–∏–∑", callback_data="show_ai_analysis_menu"),
        ]
    ])

    await message.answer(
        "üìä <b>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:</b>",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.message(Command("moderation"))
async def cmd_moderation(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞."""
    if not await check_admin(message.from_user.id):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
        return

    try:
        moderator = get_channel_moderator()
        stats = moderator.get_moderation_stats()

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
        total = stats['total_comments']
        if total > 0:
            moderated_percent = (stats['moderated_comments'] / total) * 100
            blocked_percent = (stats['blocked_comments'] / total) * 100
            spam_percent = (stats['spam_detected'] / total) * 100
            off_topic_percent = (stats['off_topic'] / total) * 100
            negative_percent = (stats['negative_sentiment'] / total) * 100
        else:
            moderated_percent = blocked_percent = spam_percent = off_topic_percent = negative_percent = 0

        report = f"""üõ°Ô∏è <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞</b>

üìä <b>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚Ä¢ –í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {total:,}
‚Ä¢ –ü—Ä–æ–º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {stats['moderated_comments']:,} ({moderated_percent:.1f}%)

üö´ <b>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:</b>
‚Ä¢ –°–ø–∞–º: {stats['spam_detected']:,} ({spam_percent:.1f}%)
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: {stats['blocked_comments']:,} ({blocked_percent:.1f}%)

‚ö†Ô∏è <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</b>
‚Ä¢ –ù–µ –ø–æ —Ç–µ–º–µ: {stats['off_topic']:,} ({off_topic_percent:.1f}%)
‚Ä¢ –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ: {stats['negative_sentiment']:,} ({negative_percent:.1f}%)

üí° <b>–ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏:</b>
‚Ä¢ –£–¥–∞–ª—è–µ—Ç —Å–ø–∞–º –∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
‚Ä¢ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
‚Ä¢ –£–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å—É–∂–¥–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª–µ"""

        # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", callback_data="moderation:reset_stats")],
            [InlineKeyboardButton(text="üìã –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç", callback_data="moderation:detailed_report")]
        ])

        await message.answer(
            report,
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error(f"Error getting moderation stats: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏")


@router.callback_query(F.data.startswith("moderation:"))
async def handle_moderation_actions(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏."""
    action = callback.data.split(":")[1]

    if action == "reset_stats":
        try:
            moderator = get_channel_moderator()
            moderator.reset_stats()

            await callback.message.edit_text(
                "‚úÖ <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω–∞</b>\n\n"
                "–ù–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—á–Ω–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å—Å—è —Å —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.",
                parse_mode="HTML"
            )
        except Exception as e:
            logger.error(f"Error resetting moderation stats: {e}")
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", show_alert=True)

    elif action == "detailed_report":
        # –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        try:
            moderator = get_channel_moderator()
            stats = moderator.get_moderation_stats()

            detailed_report = f"""üìã <b>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏</b>

üïê <b>–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è:</b>
‚Ä¢ –í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {stats['total_comments']:,}
‚Ä¢ –ú–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {stats['moderated_comments']:,}
‚Ä¢ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {stats['blocked_comments']:,}
‚Ä¢ –°–ø–∞–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω: {stats['spam_detected']:,}

üéØ <b>–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</b>
‚Ä¢ –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ: {stats['off_topic']:,}
‚Ä¢ –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ: {stats['negative_sentiment']:,}

ü§ñ <b>AI-–º–æ–¥–µ—Ä–∞—Ü–∏—è:</b>
–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (—Å–ø–∞–º, –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞)
‚Ä¢ AI-–∞–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—É–¥–∞–ª–µ–Ω–∏–µ/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)

‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</b>
‚Ä¢ –ö–∞–Ω–∞–ª: @{settings.telegram_channel_id.replace('@', '') if settings.telegram_channel_id else '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}
‚Ä¢ –ê–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏—è: ‚úÖ –í–∫–ª—é—á–µ–Ω–∞
‚Ä¢ –£—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏: –°—Ä–µ–¥–Ω–∏–π"""

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_moderation")]
            ])

            await callback.message.edit_text(
                detailed_report,
                parse_mode="HTML",
                reply_markup=keyboard
            )

        except Exception as e:
            logger.error(f"Error generating detailed moderation report: {e}")
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞", show_alert=True)

    elif action == "back_to_moderation":
        # –ò–º–∏—Ç–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ –∫–æ–º–∞–Ω–¥—ã moderation
        await callback.message.edit_text(
            "üõ°Ô∏è <b>–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–∞–Ω–∞–ª–∞</b>\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /moderation –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.",
            parse_mode="HTML"
        )

    await callback.answer()


@router.message(Command("lead_analytics"))
async def cmd_lead_analytics(message: Message, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ª–∏–¥–æ–≤."""
    if not await check_admin(message.from_user.id):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
        return

    try:
        from app.modules.analytics import AnalyticsService
        analytics = AnalyticsService(db)

        # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∑–∞ 30 –¥–Ω–µ–π
        lead_data = await analytics.get_lead_analytics(days=30)
        roi_data = await analytics.get_lead_magnet_roi(days=30)

        overview = lead_data["overview"]

        report = f"""üéØ <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ª–∏–¥–æ–≤ (30 –¥–Ω–µ–π)</b>

üìä <b>–û–±–∑–æ—Ä:</b>
‚Ä¢ –í—Å–µ–≥–æ –ª–∏–¥–æ–≤: {overview['total_leads']:,}
‚Ä¢ –ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {overview['qualified_leads']:,} ({overview['qualification_rate']}%)
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {overview['converted_leads']:,} ({overview['conversion_rate']}%)
‚Ä¢ –ó–∞–≤–µ—Ä—à–∏–ª–∏ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç: {overview['completed_magnet']:,} ({overview['magnet_completion_rate']}%)

üìù <b>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>
‚Ä¢ –° email: {overview['with_email']:,}
‚Ä¢ –° —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º: {overview['with_phone']:,}
‚Ä¢ –° –∫–æ–º–ø–∞–Ω–∏–µ–π: {overview['with_company']:,}

üìà <b>–°—Ä–µ–¥–Ω–∏–π —Å–∫–æ—Ä –ª–∏–¥–∞:</b> {overview['avg_lead_score']}/100

üí∞ <b>ROI –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞:</b>
‚Ä¢ –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ API: ${roi_data['costs']['api_cost']:.2f}
‚Ä¢ –û—Ü–µ–Ω–æ—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞: ‚ÇΩ{roi_data['revenue']['estimated_revenue']:,}
‚Ä¢ –ü—Ä–∏–±—ã–ª—å: ‚ÇΩ{roi_data['metrics']['profit']:,}
‚Ä¢ ROI: {roi_data['metrics']['roi_percent']:.1f}%

üíµ <b>–≠–∫–æ–Ω–æ–º–∏–∫–∞:</b>
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–∏–¥–∞: ‚ÇΩ{roi_data['metrics']['cost_per_lead']:.2f}
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏–¥–∞: ‚ÇΩ{roi_data['metrics']['cost_per_quality_lead']:.2f}"""

        # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(text="üìà –î–∏–Ω–∞–º–∏–∫–∞", callback_data="leads:daily_stats"),
                InlineKeyboardButton(text="üèÜ –¢–æ–ø –ª–∏–¥–æ–≤", callback_data="leads:top_leads")
            ],
            [
                InlineKeyboardButton(text="üìä –ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º", callback_data="leads:sources"),
                InlineKeyboardButton(text="üí∞ –î–µ—Ç–∞–ª—å–Ω—ã–π ROI", callback_data="leads:roi_details")
            ]
        ])

        await message.answer(
            report,
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error(f"Error getting lead analytics: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ª–∏–¥–æ–≤")


@router.callback_query(F.data.startswith("leads:"))
async def handle_lead_analytics_callbacks(callback: CallbackQuery, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ª–∏–¥–æ–≤."""
    if not await check_admin(callback.from_user.id):
        await callback.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", show_alert=True)
        return

    action = callback.data.split(":")[1]

    try:
        from app.modules.analytics import AnalyticsService
        analytics = AnalyticsService(db)

        if action == "daily_stats":
            # –î–∏–Ω–∞–º–∏–∫–∞ –ª–∏–¥–æ–≤ –ø–æ –¥–Ω—è–º
            lead_data = await analytics.get_lead_analytics(days=30)
            daily_stats = lead_data["daily_stats"][:7]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π

            report = "üìà <b>–î–∏–Ω–∞–º–∏–∫–∞ –ª–∏–¥–æ–≤ (7 –¥–Ω–µ–π)</b>\n\n"
            for stat in daily_stats:
                report += f"üìÖ {stat['date']}: +{stat['new_leads']} –ª–∏–¥–æ–≤, "
                report += f"‚úÖ {stat['completed_magnet']} –º–∞–≥–Ω–∏—Ç, "
                report += f"üéØ {stat['qualified']} –∫–≤–∞–ª–∏—Ñ.\n"

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="leads:back_to_main")]
            ])

        elif action == "top_leads":
            # –¢–æ–ø –ª–∏–¥–æ–≤ –ø–æ —Å–∫–æ—Ä–∏–Ω–≥—É
            lead_data = await analytics.get_lead_analytics(days=30)
            top_leads = lead_data["top_leads"][:5]

            report = "üèÜ <b>–¢–æ–ø-5 –ª–∏–¥–æ–≤ –ø–æ —Å–∫–æ—Ä–∏–Ω–≥—É</b>\n\n"
            for i, lead in enumerate(top_leads, 1):
                report += f"{i}. <b>{lead['full_name'] or lead['username'] or 'User'}</b>\n"
                report += f"   üìß {lead['email'] or '–Ω–µ—Ç'}\n"
                report += f"   üè¢ {lead['company'] or '–Ω–µ—Ç'}\n"
                report += f"   üìä –°–∫–æ—Ä: {lead['lead_score']}/100\n\n"

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="leads:back_to_main")]
            ])

        elif action == "sources":
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
            lead_data = await analytics.get_lead_analytics(days=30)
            sources_stats = lead_data["sources_stats"]

            report = "üìä <b>–õ–∏–¥—ã –ø–æ —Å—Ñ–µ—Ä–∞–º –±–∏–∑–Ω–µ—Å–∞</b>\n\n"
            for source in sources_stats:
                report += f"üèóÔ∏è <b>{source['source']}</b>: {source['count']} –ª–∏–¥–æ–≤\n"
                report += f"   üìà –°—Ä. —Å–∫–æ—Ä: {source['avg_score']}/100\n"
                report += f"   ‚úÖ –ó–∞–≤–µ—Ä—à–∏–ª–∏: {source['completed_rate']}%\n\n"

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="leads:back_to_main")]
            ])

        elif action == "roi_details":
            # –î–µ—Ç–∞–ª—å–Ω—ã–π ROI
            roi_data = await analytics.get_lead_magnet_roi(days=30)

            report = f"""üí∞ <b>–î–µ—Ç–∞–ª—å–Ω—ã–π ROI –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞</b>

üíµ <b>–ó–∞—Ç—Ä–∞—Ç—ã:</b>
‚Ä¢ API OpenAI/Perplexity: ${roi_data['costs']['api_cost']:.2f}
‚Ä¢ –ò—Ç–æ–≥–æ –∑–∞—Ç—Ä–∞—Ç: ${roi_data['costs']['total_cost']:.2f}

üìà <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>
‚Ä¢ –í—Å–µ–≥–æ –ª–∏–¥–æ–≤: {roi_data['revenue']['total_leads']:,}
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤: {roi_data['revenue']['quality_leads']:,}
‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –ª–∏–¥–∞: ‚ÇΩ{roi_data['revenue']['assumed_lead_value']:,}
‚Ä¢ –û—Ü–µ–Ω–æ—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞: ‚ÇΩ{roi_data['revenue']['estimated_revenue']:,}

üìä <b>–ú–µ—Ç—Ä–∏–∫–∏:</b>
‚Ä¢ –ü—Ä–∏–±—ã–ª—å: ‚ÇΩ{roi_data['metrics']['profit']:,}
‚Ä¢ ROI: {roi_data['metrics']['roi_percent']:.1f}%
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–∏–¥–∞: ‚ÇΩ{roi_data['metrics']['cost_per_lead']:.2f}
‚Ä¢ –°—Ä. —Å–∫–æ—Ä –ª–∏–¥–∞: {roi_data['metrics']['avg_lead_score']:.1f}/100"""

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="leads:back_to_main")]
            ])

        elif action == "back_to_main":
            # –í–æ–∑–≤—Ä–∞—Ç –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –ª–∏–¥–æ–≤
            lead_data = await analytics.get_lead_analytics(days=30)
            roi_data = await analytics.get_lead_magnet_roi(days=30)
            overview = lead_data["overview"]

            report = f"""üéØ <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ª–∏–¥–æ–≤ (30 –¥–Ω–µ–π)</b>

üìä <b>–û–±–∑–æ—Ä:</b>
‚Ä¢ –í—Å–µ–≥–æ –ª–∏–¥–æ–≤: {overview['total_leads']:,}
‚Ä¢ –ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {overview['qualified_leads']:,} ({overview['qualification_rate']}%)
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {overview['converted_leads']:,} ({overview['conversion_rate']}%)
‚Ä¢ –ó–∞–≤–µ—Ä—à–∏–ª–∏ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç: {overview['completed_magnet']:,} ({overview['magnet_completion_rate']}%)

üí∞ <b>ROI:</b> {roi_data['metrics']['roi_percent']:.1f}% (‚ÇΩ{roi_data['metrics']['profit']:,} –ø—Ä–∏–±—ã–ª–∏)"""

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="üìà –î–∏–Ω–∞–º–∏–∫–∞", callback_data="leads:daily_stats"),
                    InlineKeyboardButton(text="üèÜ –¢–æ–ø –ª–∏–¥–æ–≤", callback_data="leads:top_leads")
                ],
                [
                    InlineKeyboardButton(text="üìä –ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º", callback_data="leads:sources"),
                    InlineKeyboardButton(text="üí∞ –î–µ—Ç–∞–ª—å–Ω—ã–π ROI", callback_data="leads:roi_details")
                ]
            ])

        await callback.message.edit_text(
            report,
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error(f"Error in lead analytics callback: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞", show_alert=True)

    await callback.answer()


@router.message(Command("settings"))
async def cmd_settings(message: Message, db: AsyncSession):
    """–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."""

    if not await check_admin(message.from_user.id):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
        return

    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üì∞ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="settings:sources")],
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª–∏ LLM", callback_data="settings:llm")],
        [InlineKeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (DALL-E)", callback_data="settings:dalle")],
        [InlineKeyboardButton(text="üìÖ –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è", callback_data="settings:autopublish")],
        [InlineKeyboardButton(text="üîÑ –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="settings:fetcher")],
        [InlineKeyboardButton(text="üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", callback_data="settings:alerts")],
        [InlineKeyboardButton(text="üéØ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ", callback_data="settings:quality")],
        [InlineKeyboardButton(text="üí∞ –ë—é–¥–∂–µ—Ç API", callback_data="settings:budget")],
    ])

    await message.answer(
        "‚öôÔ∏è <b>–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
        "–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.callback_query(F.data == "settings:sources")
async def callback_settings_sources(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–æ–≤–æ—Å—Ç–µ–π."""
    await callback.answer()

    from app.modules.settings_manager import get_category_settings

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    sources = await get_category_settings("sources", db)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≥–∞–ª–æ—á–∫–∞–º–∏
    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

    source_config = {
        "google_news_ru": "Google News RSS (RU)",
        "google_news_en": "Google News RSS (EN)",
        "google_news_rss_ru": "Google News RU",
        "google_news_rss_en": "Google News EN",
        "habr": "Habr - –ù–æ–≤–æ—Å—Ç–∏",
        "perplexity_ru": "Perplexity Search (RU)",
        "perplexity_en": "Perplexity Search (EN)",
        "telegram_channels": "Telegram Channels",
        "interfax": "Interfax - –ù–∞—É–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
        "lenta": "Lenta.ru - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
        "rbc": "RBC - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
        "tass": "TASS - –ù–∞—É–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
    }

    buttons = []
    for key, name in source_config.items():
        is_enabled = sources.get(f"sources.{key}.enabled", True)
        icon = "‚úÖ" if is_enabled else "‚òê"
        buttons.append([
            InlineKeyboardButton(
                text=f"{icon} {name}",
                callback_data=f"toggle_source:{key}"
            )
        ])

    buttons.append([InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")])

    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)

    await callback.message.edit_text(
        "üì∞ <b>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</b>\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –µ–≥–æ.\n"
        "–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.\n\n"
        "‚úÖ - –≤–∫–ª—é—á–µ–Ω\n"
        "‚òê - –≤—ã–∫–ª—é—á–µ–Ω",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.callback_query(F.data.startswith("toggle_source:"))
async def callback_toggle_source(callback: CallbackQuery, db: AsyncSession):
    """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫."""
    source_key = callback.data.split(":")[1]

    from app.modules.settings_manager import get_setting, set_setting

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    setting_key = f"sources.{source_key}.enabled"
    current_value = await get_setting(setting_key, db, default=True)

    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º
    new_value = not current_value
    await set_setting(setting_key, new_value, db)

    # –û–±–Ω–æ–≤–ª—è–µ–º UI
    await callback.answer(f"{'‚úÖ –í–∫–ª—é—á–µ–Ω' if new_value else '‚òê –í—ã–∫–ª—é—á–µ–Ω'}")
    await callback_settings_sources(callback, db)


@router.callback_query(F.data == "back_to_settings")
async def callback_back_to_settings(callback: CallbackQuery, db: AsyncSession):
    """–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
    await callback.answer()

    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üì∞ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="settings:sources")],
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª–∏ LLM", callback_data="settings:llm")],
        [InlineKeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (DALL-E)", callback_data="settings:dalle")],
        [InlineKeyboardButton(text="üìÖ –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è", callback_data="settings:autopublish")],
        [InlineKeyboardButton(text="üîÑ –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="settings:fetcher")],
        [InlineKeyboardButton(text="üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", callback_data="settings:alerts")],
        [InlineKeyboardButton(text="üéØ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ", callback_data="settings:quality")],
        [InlineKeyboardButton(text="üí∞ –ë—é–¥–∂–µ—Ç API", callback_data="settings:budget")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_main_menu")],
    ])

    await callback.message.edit_text(
        "‚öôÔ∏è <b>–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
        "–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.callback_query(F.data == "settings:llm")
async def callback_settings_llm(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–µ–π LLM."""
    from app.modules.settings_manager import get_setting

    current_provider = await get_setting("llm.provider", db, default="deepseek")
    current_analysis = await get_setting("llm.analysis.model", db, default="deepseek-chat")
    current_draft = await get_setting("llm.draft_generation.model", db, default="deepseek-chat")
    current_ranking = await get_setting("llm.ranking.model", db, default="deepseek-chat")

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"üîå –ü—Ä–æ–≤–∞–π–¥–µ—Ä: {current_provider}", callback_data="llm_provider_select")],
        [InlineKeyboardButton(text=f"üîç –ê–Ω–∞–ª–∏–∑: {current_analysis}", callback_data="llm_select:analysis")],
        [InlineKeyboardButton(text=f"‚úçÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥—Ä–∞—Ñ—Ç–æ–≤: {current_draft}", callback_data="llm_select:draft_generation")],
        [InlineKeyboardButton(text=f"üìä –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ: {current_ranking}", callback_data="llm_select:ranking")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
    ])

    await callback.message.edit_text(
        "ü§ñ <b>–ú–æ–¥–µ–ª–∏ LLM</b>\n\n"
        "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:\n\n"
        "‚Ä¢ <b>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</b> - –≤—ã–±–æ—Ä LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (DeepSeek/OpenAI/Perplexity)\n"
        "‚Ä¢ <b>–ê–Ω–∞–ª–∏–∑</b> - AI –∞–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–µ–π –∏ –º–µ—Ç—Ä–∏–∫\n"
        "‚Ä¢ <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥—Ä–∞—Ñ—Ç–æ–≤</b> - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –ø–æ—Å—Ç–æ–≤\n"
        "‚Ä¢ <b>–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ</b> - scoring –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ç–µ–π\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "llm_provider_select")
async def callback_llm_provider_select(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."""
    from app.modules.settings_manager import get_setting

    current_provider = await get_setting("llm.provider", db, default="deepseek")

    # –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Å –≥–∞–ª–æ—á–∫–∞–º–∏
    providers = [
        ("deepseek", "DeepSeek V3 (–¥–µ—à–µ–≤–ª–µ)"),
        ("openai", "OpenAI (GPT-4)"),
        ("perplexity", "Perplexity (Llama 3.1)"),
    ]

    buttons = []
    for provider_id, provider_name in providers:
        checkmark = "‚úÖ " if current_provider == provider_id else ""
        buttons.append([InlineKeyboardButton(
            text=f"{checkmark}{provider_name}",
            callback_data=f"provider_select:{provider_id}"
        )])

    buttons.append([InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:llm")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)

    await callback.message.edit_text(
        "üîå <b>–í—ã–±–æ—Ä LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</b>\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:\n\n"
        "‚Ä¢ <b>DeepSeek V3</b> - —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π (~$0.14/1M —Ç–æ–∫–µ–Ω–æ–≤)\n"
        "‚Ä¢ <b>OpenAI GPT-4</b> - —Ç–æ—á–Ω–∞—è, —Å—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å\n"
        "‚Ä¢ <b>Perplexity</b> - –¥–æ—Å—Ç—É–ø –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n\n"
        "‚úÖ - —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä\n"
        "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data.startswith("provider_select:"))
async def callback_provider_select(callback: CallbackQuery, db: AsyncSession):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä."""
    from app.modules.settings_manager import set_setting

    provider = callback.data.split(":")[1]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await set_setting("llm.provider", provider, db)

    await callback.answer(f"‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {provider}", show_alert=True)

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é LLM –Ω–∞—Å—Ç—Ä–æ–µ–∫
    callback.data = "settings:llm"
    await callback_settings_llm(callback, db)


@router.callback_query(F.data.startswith("llm_select:"))
async def callback_llm_select(callback: CallbackQuery, db: AsyncSession):
    """–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ LLM –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏."""
    from app.modules.settings_manager import get_setting

    operation = callback.data.split(":")[1]

    operation_names = {
        "analysis": "–ê–Ω–∞–ª–∏–∑",
        "draft_generation": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥—Ä–∞—Ñ—Ç–æ–≤",
        "ranking": "–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ"
    }

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä
    current_model = await get_setting(f"llm.{operation}.model", db, default="deepseek-chat")
    current_provider = await get_setting("llm.provider", db, default="deepseek")

    # Available models based on provider
    all_models = [
        ("deepseek-chat", "DeepSeek Chat (–¥–µ—à–µ–≤–ª–µ –≤—Å–µ–≥–æ)"),
        ("gpt-4o", "GPT-4o (—Å–∞–º–∞—è —É–º–Ω–∞—è)"),
        ("gpt-4o-mini", "GPT-4o-mini (–±—ã—Å—Ç—Ä–∞—è)"),
    ]

    buttons = []
    for model_key, model_name in all_models:
        icon = "‚úÖ" if current_model == model_key else "‚òê"
        buttons.append([
            InlineKeyboardButton(
                text=f"{icon} {model_name}",
                callback_data=f"llm_set:{operation}:{model_key}"
            )
        ])

    buttons.append([InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:llm")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)

    await callback.message.edit_text(
        f"ü§ñ <b>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è: {operation_names.get(operation, operation)}</b>\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:\n\n"
        "‚Ä¢ <b>DeepSeek Chat</b> - —Å–∞–º–∞—è –¥–µ—à–µ–≤–∞—è (~$0.14/1M —Ç–æ–∫–µ–Ω–æ–≤)\n"
        "‚Ä¢ <b>GPT-4o</b> - —Å–∞–º–∞—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è, —Ç–æ—á–Ω–∞—è, –¥–æ—Ä–æ–≥–∞—è (~$15/1M —Ç–æ–∫–µ–Ω–æ–≤)\n"
        "‚Ä¢ <b>GPT-4o-mini</b> - –±—ã—Å—Ç—Ä–∞—è, –¥–µ—à–µ–≤–∞—è (~$0.15/1M —Ç–æ–∫–µ–Ω–æ–≤)\n"
        ""
        "‚úÖ - –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å\n"
        "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data.startswith("llm_set:"))
async def callback_llm_set(callback: CallbackQuery, db: AsyncSession):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å LLM."""
    _, operation, model = callback.data.split(":")
    from app.modules.settings_manager import set_setting

    setting_key = f"llm.{operation}.model"
    await set_setting(setting_key, model, db)

    await callback.answer(f"‚úÖ {model}")

    # –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω —Å –Ω–æ–≤—ã–º–∏ –≥–∞–ª–æ—á–∫–∞–º–∏
    callback.data = f"llm_select:{operation}"
    await callback_llm_select(callback, db)


@router.callback_query(F.data == "settings:dalle")
async def callback_settings_dalle(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ DALL-E –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."""
    from app.modules.settings_manager import get_dalle_config

    config = await get_dalle_config(db)

    enabled_icon = "‚úÖ" if config["enabled"] else "‚òê"
    auto_icon = "‚úÖ" if config["auto_generate"] else "‚òê"
    ask_icon = "‚úÖ" if config["ask_on_review"] else "‚òê"

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{enabled_icon} –í–∫–ª—é—á–∏—Ç—å DALL-E", callback_data="toggle:dalle.enabled")],
        [InlineKeyboardButton(text=f"üé® –ú–æ–¥–µ–ª—å: {config['model']}", callback_data="dalle_model_select")],
        [InlineKeyboardButton(text=f"üíé –ö–∞—á–µ—Å—Ç–≤–æ: {config['quality']}", callback_data="dalle_quality_select")],
        [InlineKeyboardButton(text=f"üìê –†–∞–∑–º–µ—Ä: {config['size']}", callback_data="dalle_size_select")],
        [InlineKeyboardButton(text=f"{auto_icon} –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤", callback_data="toggle:dalle.auto_generate")],
        [InlineKeyboardButton(text=f"{ask_icon} –°–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø—Ä–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏", callback_data="toggle:dalle.ask_on_review")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
    ])

    await callback.message.edit_text(
        "üé® <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (DALL-E)</b>\n\n"
        f"–°—Ç–∞—Ç—É—Å: {'üü¢ –í–∫–ª—é—á–µ–Ω–æ' if config['enabled'] else 'üî¥ –í—ã–∫–ª—é—á–µ–Ω–æ'}\n\n"
        "‚Ä¢ <b>–ú–æ–¥–µ–ª—å</b> - DALL-E 2 –∏–ª–∏ DALL-E 3\n"
        "‚Ä¢ <b>–ö–∞—á–µ—Å—Ç–≤–æ</b> - standard (–¥–µ—à–µ–≤–ª–µ) –∏–ª–∏ hd (–¥–µ—Ç–∞–ª—å–Ω–µ–µ)\n"
        "‚Ä¢ <b>–†–∞–∑–º–µ—Ä</b> - 1024x1024, 1792x1024, 1024x1792\n"
        "‚Ä¢ <b>–ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</b> - —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞\n"
        "‚Ä¢ <b>–°–ø—Ä–∞—à–∏–≤–∞—Ç—å</b> - –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏\n\n"
        "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.04-0.12 –∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data.startswith("toggle:"))
async def callback_toggle_setting(callback: CallbackQuery, db: AsyncSession):
    """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –±—É–ª–µ–≤—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É."""
    setting_key = callback.data.split(":")[1]
    from app.modules.settings_manager import get_setting, set_setting

    current_value = await get_setting(setting_key, db, default=False)
    new_value = not current_value
    await set_setting(setting_key, new_value, db)

    await callback.answer(f"{'‚úÖ –í–∫–ª—é—á–µ–Ω–æ' if new_value else '‚òê –í—ã–∫–ª—é—á–µ–Ω–æ'}")

    # Redirect back to appropriate menu
    if setting_key.startswith("dalle."):
        await callback_settings_dalle(callback, db)
    elif setting_key.startswith("auto_publish."):
        await callback_settings_autopublish(callback, db)
    elif setting_key.startswith("alerts."):
        await callback_settings_alerts(callback, db)
    elif setting_key.startswith("budget."):
        await callback_settings_budget(callback, db)


@router.callback_query(F.data == "dalle_model_select")
async def callback_dalle_model_select(callback: CallbackQuery, db: AsyncSession):
    """–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ DALL-E."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="DALL-E 3 (–ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="dalle_set:model:dall-e-3")],
        [InlineKeyboardButton(text="DALL-E 2 (–¥–µ—à–µ–≤–ª–µ)", callback_data="dalle_set:model:dall-e-2")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:dalle")],
    ])

    await callback.message.edit_text(
        "üé® <b>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ DALL-E</b>\n\n"
        "‚Ä¢ <b>DALL-E 3</b> - –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (~$0.04-0.12)\n"
        "‚Ä¢ <b>DALL-E 2</b> - –±–∞–∑–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –¥–µ—à–µ–≤–ª–µ (~$0.02)\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "dalle_quality_select")
async def callback_dalle_quality_select(callback: CallbackQuery, db: AsyncSession):
    """–í—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ DALL-E."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="HD (–≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="dalle_set:quality:hd")],
        [InlineKeyboardButton(text="Standard (–±–∞–∑–æ–≤–æ–µ)", callback_data="dalle_set:quality:standard")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:dalle")],
    ])

    await callback.message.edit_text(
        "üíé <b>–ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</b>\n\n"
        "‚Ä¢ <b>HD</b> - –≤—ã—Å–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (–≤ 2x –¥–æ—Ä–æ–∂–µ)\n"
        "‚Ä¢ <b>Standard</b> - –±–∞–∑–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "dalle_size_select")
async def callback_dalle_size_select(callback: CallbackQuery, db: AsyncSession):
    """–í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è DALL-E."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="1024x1024 (–∫–≤–∞–¥—Ä–∞—Ç)", callback_data="dalle_set:size:1024x1024")],
        [InlineKeyboardButton(text="1792x1024 (–≥–æ—Ä–∏–∑–æ–Ω—Ç)", callback_data="dalle_set:size:1792x1024")],
        [InlineKeyboardButton(text="1024x1792 (–≤–µ—Ä—Ç–∏–∫–∞–ª—å)", callback_data="dalle_set:size:1024x1792")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:dalle")],
    ])

    await callback.message.edit_text(
        "üìê <b>–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b>\n\n"
        "‚Ä¢ <b>1024x1024</b> - –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n"
        "‚Ä¢ <b>1792x1024</b> - –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (–¥–ª—è –ø–æ—Å—Ç–æ–≤)\n"
        "‚Ä¢ <b>1024x1792</b> - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (–¥–ª—è stories)\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data.startswith("dalle_set:"))
async def callback_dalle_set(callback: CallbackQuery, db: AsyncSession):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä DALL-E."""
    _, param, value = callback.data.split(":")
    from app.modules.settings_manager import set_setting

    setting_key = f"dalle.{param}"
    await set_setting(setting_key, value, db)

    await callback.answer(f"‚úÖ {param.capitalize()} –æ–±–Ω–æ–≤–ª–µ–Ω: {value}")
    await callback_settings_dalle(callback, db)


@router.callback_query(F.data == "settings:autopublish")
async def callback_settings_autopublish(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏."""
    from app.modules.settings_manager import get_auto_publish_config

    config = await get_auto_publish_config(db)

    enabled_icon = "‚úÖ" if config["enabled"] else "‚òê"
    weekdays_icon = "‚úÖ" if config["weekdays_only"] else "‚òê"
    holidays_icon = "‚úÖ" if config["skip_holidays"] else "‚òê"

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{enabled_icon} –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é", callback_data="toggle:auto_publish.enabled")],
        [InlineKeyboardButton(text=f"‚è∞ –†–µ–∂–∏–º: {config['mode']}", callback_data="autopublish_mode_select")],
        [InlineKeyboardButton(text=f"üìä –ú–∞–∫—Å. –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å: {config['max_per_day']}", callback_data="autopublish_max_select")],
        [InlineKeyboardButton(text=f"{weekdays_icon} –¢–æ–ª—å–∫–æ –≤ –±—É–¥–Ω–∏", callback_data="toggle:auto_publish.weekdays_only")],
        [InlineKeyboardButton(text=f"{holidays_icon} –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏", callback_data="toggle:auto_publish.skip_holidays")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
    ])

    mode_desc = {
        "best_time": "–õ—É—á—à–µ–µ –≤—Ä–µ–º—è (AI –≤—ã–±–∏—Ä–∞–µ—Ç)",
        "schedule": "–ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é",
        "even": "–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è"
    }

    await callback.message.edit_text(
        "üìÖ <b>–ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è</b>\n\n"
        f"–°—Ç–∞—Ç—É—Å: {'üü¢ –í–∫–ª—é—á–µ–Ω–æ' if config['enabled'] else 'üî¥ –í—ã–∫–ª—é—á–µ–Ω–æ'}\n"
        f"–†–µ–∂–∏–º: {mode_desc.get(config['mode'], config['mode'])}\n\n"
        "‚Ä¢ <b>–†–µ–∂–∏–º</b> - –∫–æ–≥–¥–∞ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã\n"
        "‚Ä¢ <b>–ú–∞–∫—Å. –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å</b> - –ª–∏–º–∏—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π\n"
        "‚Ä¢ <b>–¢–æ–ª—å–∫–æ –≤ –±—É–¥–Ω–∏</b> - –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ\n"
        "‚Ä¢ <b>–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏</b> - –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏\n\n"
        "‚ö†Ô∏è –ü–æ—Å—Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é!",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "autopublish_mode_select")
async def callback_autopublish_mode_select(callback: CallbackQuery, db: AsyncSession):
    """–í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚è∞ –õ—É—á—à–µ–µ –≤—Ä–µ–º—è (AI)", callback_data="autopublish_set:mode:best_time")],
        [InlineKeyboardButton(text="üìÖ –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é", callback_data="autopublish_set:mode:schedule")],
        [InlineKeyboardButton(text="‚è≥ –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ", callback_data="autopublish_set:mode:even")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:autopublish")],
    ])

    await callback.message.edit_text(
        "‚è∞ <b>–†–µ–∂–∏–º –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏</b>\n\n"
        "‚Ä¢ <b>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</b> - AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç\n"
        "  –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ engagement\n\n"
        "‚Ä¢ <b>–ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</b> - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (9:00, 14:00, 18:00)\n\n"
        "‚Ä¢ <b>–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ</b> - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "autopublish_max_select")
async def callback_autopublish_max_select(callback: CallbackQuery, db: AsyncSession):
    """–í—ã–±–æ—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="1 –ø–æ—Å—Ç/–¥–µ–Ω—å", callback_data="autopublish_set:max_per_day:1")],
        [InlineKeyboardButton(text="2 –ø–æ—Å—Ç–∞/–¥–µ–Ω—å", callback_data="autopublish_set:max_per_day:2")],
        [InlineKeyboardButton(text="3 –ø–æ—Å—Ç–∞/–¥–µ–Ω—å", callback_data="autopublish_set:max_per_day:3")],
        [InlineKeyboardButton(text="5 –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å", callback_data="autopublish_set:max_per_day:5")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="settings:autopublish")],
    ])

    await callback.message.edit_text(
        "üìä <b>–ú–∞–∫—Å–∏–º—É–º –ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å</b>\n\n"
        "–°–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –¥–µ–Ω—å?\n\n"
        "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 2-3 –ø–æ—Å—Ç–∞ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–º–∏—Ç:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data.startswith("autopublish_set:"))
async def callback_autopublish_set(callback: CallbackQuery, db: AsyncSession):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏."""
    _, param, value = callback.data.split(":")
    from app.modules.settings_manager import set_setting

    setting_key = f"auto_publish.{param}"
    # Convert to int if it's max_per_day
    if param == "max_per_day":
        value = int(value)

    await set_setting(setting_key, value, db)

    await callback.answer(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {value}")
    await callback_settings_autopublish(callback, db)


@router.callback_query(F.data == "settings:alerts")
async def callback_settings_alerts(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π."""
    from app.modules.settings_manager import get_category_settings

    alerts = await get_category_settings("alerts", db)

    low_eng_icon = "‚úÖ" if alerts.get("alerts.low_engagement.enabled", True) else "‚òê"
    viral_icon = "‚úÖ" if alerts.get("alerts.viral_post.enabled", True) else "‚òê"
    low_appr_icon = "‚úÖ" if alerts.get("alerts.low_approval.enabled", True) else "‚òê"
    fetch_err_icon = "‚úÖ" if alerts.get("alerts.fetch_errors.enabled", True) else "‚òê"
    api_lim_icon = "‚úÖ" if alerts.get("alerts.api_limits.enabled", True) else "‚òê"

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{low_eng_icon} –ü–∞–¥–µ–Ω–∏–µ engagement", callback_data="toggle:alerts.low_engagement.enabled")],
        [InlineKeyboardButton(text=f"  ‚îî –ü–æ—Ä–æ–≥: {alerts.get('alerts.low_engagement.threshold', 20)}%", callback_data="alert_threshold:low_engagement")],
        [InlineKeyboardButton(text=f"{viral_icon} Viral –ø–æ—Å—Ç", callback_data="toggle:alerts.viral_post.enabled")],
        [InlineKeyboardButton(text=f"  ‚îî –ü–æ—Ä–æ–≥: {alerts.get('alerts.viral_post.threshold', 100)} –ø—Ä–æ—Å–º.", callback_data="alert_threshold:viral_post")],
        [InlineKeyboardButton(text=f"{low_appr_icon} –ù–∏–∑–∫–∏–π approval rate", callback_data="toggle:alerts.low_approval.enabled")],
        [InlineKeyboardButton(text=f"  ‚îî –ü–æ—Ä–æ–≥: {alerts.get('alerts.low_approval.threshold', 30)}%", callback_data="alert_threshold:low_approval")],
        [InlineKeyboardButton(text=f"{fetch_err_icon} –û—à–∏–±–∫–∏ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data="toggle:alerts.fetch_errors.enabled")],
        [InlineKeyboardButton(text=f"{api_lim_icon} –õ–∏–º–∏—Ç—ã API", callback_data="toggle:alerts.api_limits.enabled")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
    ])

    await callback.message.edit_text(
        "üîî <b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∞–ª–µ—Ä—Ç—ã</b>\n\n"
        "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:\n\n"
        "‚Ä¢ <b>–ü–∞–¥–µ–Ω–∏–µ engagement</b> - –µ—Å–ª–∏ engagement –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞\n"
        "‚Ä¢ <b>Viral –ø–æ—Å—Ç</b> - –µ—Å–ª–∏ –ø–æ—Å—Ç –Ω–∞–±—Ä–∞–ª –º–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤\n"
        "‚Ä¢ <b>–ù–∏–∑–∫–∏–π approval</b> - –µ—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –º–Ω–æ–≥–æ —Å—Ç–∞—Ç–µ–π\n"
        "‚Ä¢ <b>–û—à–∏–±–∫–∏ —Å–±–æ—Ä–∞</b> - –ø—Ä–æ–±–ª–µ–º—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏\n"
        "‚Ä¢ <b>–õ–∏–º–∏—Ç—ã API</b> - –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –ª–∏–º–∏—Ç–∞–º\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ä–æ–≥–æ–≤:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data.startswith("alert_threshold:"))
async def callback_alert_threshold(callback: CallbackQuery):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∑–∞–≥–ª—É—à–∫–∞)."""
    alert_type = callback.data.split(":")[1]

    alert_names = {
        "low_engagement": "–ü–∞–¥–µ–Ω–∏–µ engagement",
        "viral_post": "Viral –ø–æ—Å—Ç",
        "low_approval": "–ù–∏–∑–∫–∏–π approval rate"
    }

    await callback.answer(
        f"‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞ –¥–ª—è '{alert_names.get(alert_type, alert_type)}' –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏",
        show_alert=True
    )


@router.callback_query(F.data.startswith("quality_param:"))
async def callback_quality_param(callback: CallbackQuery):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–∞—á–µ—Å—Ç–≤–∞ (–∑–∞–≥–ª—É—à–∫–∞)."""
    param = callback.data.split(":")[1]

    param_names = {
        "min_score": "–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ quality score",
        "min_content_length": "–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞",
        "similarity_threshold": "–ø–æ—Ä–æ–≥–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏",
        "languages": "—è–∑—ã–∫–æ–≤"
    }

    await callback.answer(
        f"‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ {param_names.get(param, param)} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏",
        show_alert=True
    )


@router.callback_query(F.data.startswith("budget_param:"))
async def callback_budget_param(callback: CallbackQuery):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—é–¥–∂–µ—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)."""
    param = callback.data.split(":")[1]

    param_names = {
        "max_per_month": "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞",
        "warning_threshold": "–ø–æ—Ä–æ–≥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è"
    }

    await callback.answer(
        f"‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ {param_names.get(param, param)} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏",
        show_alert=True
    )


@router.callback_query(F.data == "settings:quality")
async def callback_settings_quality(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞."""
    from app.modules.settings_manager import get_category_settings

    quality = await get_category_settings("quality", db)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"‚≠ê –ú–∏–Ω. quality score: {quality.get('quality.min_score', 0.6)}", callback_data="quality_param:min_score")],
        [InlineKeyboardButton(text=f"üìù –ú–∏–Ω. –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {quality.get('quality.min_content_length', 300)}", callback_data="quality_param:min_content_length")],
        [InlineKeyboardButton(text=f"üîÑ –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏: {quality.get('quality.similarity_threshold', 0.85)}", callback_data="quality_param:similarity_threshold")],
        [InlineKeyboardButton(text=f"üåê –Ø–∑—ã–∫–∏: {', '.join(quality.get('quality.languages', ['ru', 'en']))}", callback_data="quality_param:languages")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
    ])

    await callback.message.edit_text(
        "üéØ <b>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ</b>\n\n"
        "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–µ–π:\n\n"
        "‚Ä¢ <b>Quality score</b> - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª AI (0.0-1.0)\n"
        "‚Ä¢ <b>–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞</b> - –º–∏–Ω–∏–º—É–º —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç–∞—Ç—å–µ\n"
        "‚Ä¢ <b>–ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏</b> - —Ñ–∏–ª—å—Ç—Ä –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (0.0-1.0)\n"
        "‚Ä¢ <b>–Ø–∑—ã–∫–∏</b> - —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —è–∑—ã–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n\n"
        "‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –º–æ–≥—É—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –º–∞–ª–æ —Å—Ç–∞—Ç–µ–π!",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()


@router.callback_query(F.data == "settings:budget")
async def callback_settings_budget(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—é–¥–∂–µ—Ç–∞ API."""
    from app.modules.settings_manager import get_category_settings

    budget = await get_category_settings("budget", db)

    stop_icon = "‚úÖ" if budget.get("budget.stop_on_exceed", False) else "‚òê"
    switch_icon = "‚úÖ" if budget.get("budget.switch_to_cheap", True) else "‚òê"

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"üí∞ –ú–∞–∫—Å. –±—é–¥–∂–µ—Ç/–º–µ—Å—è—Ü: ${budget.get('budget.max_per_month', 10)}", callback_data="budget_param:max_per_month")],
        [InlineKeyboardButton(text=f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏: ${budget.get('budget.warning_threshold', 8)}", callback_data="budget_param:warning_threshold")],
        [InlineKeyboardButton(text=f"{stop_icon} –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏", callback_data="toggle:budget.stop_on_exceed")],
        [InlineKeyboardButton(text=f"{switch_icon} –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥–µ—à–µ–≤—ã–µ –º–æ–¥–µ–ª–∏", callback_data="toggle:budget.switch_to_cheap")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
    ])

    await callback.message.edit_text(
        "üí∞ <b>–ë—é–¥–∂–µ—Ç API</b>\n\n"
        "–ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ OpenAI API:\n\n"
        "‚Ä¢ <b>–ú–∞–∫—Å. –±—é–¥–∂–µ—Ç</b> - –ª–∏–º–∏—Ç –≤ $ –Ω–∞ –º–µ—Å—è—Ü\n"
        "‚Ä¢ <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</b> - –∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç\n"
        "‚Ä¢ <b>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</b> - –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏\n"
        "‚Ä¢ <b>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è</b> - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—à–µ–≤—ã–µ –º–æ–¥–µ–ª–∏\n\n"
        f"üìä –¢–µ–∫—É—â–∏–π —Ä–∞—Å—Ö–æ–¥: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ –ë–î\n"
        "üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥–µ—à–µ–≤—ã–µ –º–æ–¥–µ–ª–∏'",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    await callback.answer()



# ====================
# Personal Posts Handlers
# ====================

@router.callback_query(F.data == "show_personal_posts")
async def callback_show_personal_posts(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –ª–∏—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤."""
    await callback.answer()

    from app.modules.personal_posts_manager import get_user_posts

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    posts = await get_user_posts(callback.from_user.id, db, limit=5)

    posts_text = ""
    if posts:
        posts_text = "\n\n<b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏:</b>\n"
        for post in posts:
            date_str = post.created_at.strftime("%d.%m.%Y")
            title = post.title or post.content[:50] + "..."
            posts_text += f"\n‚Ä¢ {date_str}: {title}"
    else:
        posts_text = "\n\n<i>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫</i>"

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É", callback_data="create_personal_post")],
        [InlineKeyboardButton(text="üìö –í—Å–µ –º–æ–∏ –∑–∞–º–µ—Ç–∫–∏", callback_data="list_personal_posts")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_main_menu")],
    ])

    await callback.message.edit_text(
        "‚úçÔ∏è <b>–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</b>\n\n"
        "–õ–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ —Ä–∞–±–æ—Ç—ã —Å AI. –§–∏–∫—Å–∏—Ä—É–π—Ç–µ –∏–¥–µ–∏, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã, –∏–Ω—Å–∞–π—Ç—ã.\n"
        "–ó–∞–º–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∏ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏."
        f"{posts_text}",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.callback_query(F.data == "create_personal_post")
async def callback_create_personal_post(callback: CallbackQuery):
    """–í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞."""
    await callback.answer()

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìù –ù–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ", callback_data="post_manual")],
        [InlineKeyboardButton(text="ü§ñ –°–æ–∑–¥–∞—Ç—å —Å –ø–æ–º–æ—â—å—é AI", callback_data="post_ai_assisted")],
        [InlineKeyboardButton(text="üé§ –ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–º", callback_data="post_voice")],
        [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="show_personal_posts")],
    ])

    await callback.message.edit_text(
        "‚úçÔ∏è <b>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è:\n\n"
        "‚Ä¢ <b>–ù–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ</b> - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç\n"
        "‚Ä¢ <b>–°–æ–∑–¥–∞—Ç—å —Å AI</b> - –æ–ø–∏—à–∏—Ç–µ –∏–¥–µ–∏, AI —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ—Å—Ç\n"
        "‚Ä¢ <b>–ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å</b> - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n"
        "–í—Å–µ –∑–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–≤—è–∑–µ–π.",
        parse_mode="HTML",
        reply_markup=keyboard
    )


# FSM States –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤
class PersonalPostStates(StatesGroup):
    waiting_manual_text = State()
    waiting_ai_ideas = State()
    waiting_ai_feedback = State()
    waiting_voice = State()
    waiting_edit_text = State()
    waiting_comment = State()


@router.callback_query(F.data == "post_manual")
async def callback_post_manual(callback: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –≤—Ä—É—á–Ω—É—é."""
    await callback.answer()

    await state.set_state(PersonalPostStates.waiting_manual_text)

    await callback.message.edit_text(
        "üìù <b>–ù–∞–ø–∏—Å–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</b>\n\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—à–µ–π –∑–∞–º–µ—Ç–∫–∏. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º, –∏ —è —Å–æ—Ö—Ä–∞–Ω—é –µ–≥–æ.",
        parse_mode="HTML"
    )


@router.message(PersonalPostStates.waiting_manual_text)
async def process_manual_post(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç —Ä—É—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞."""
    from app.modules.personal_posts_manager import create_personal_post, enrich_post_with_metadata

    content = message.text

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä typing
    await message.bot.send_chat_action(message.chat.id, "typing")

    # –°–æ–∑–¥–∞—ë–º –ø–æ—Å—Ç
    post = await create_personal_post(
        user_id=message.from_user.id,
        content=content,
        db=db,
        creation_method="manual"
    )

    # –û–±–æ–≥–∞—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –≤ —Ñ–æ–Ω–µ
    await message.answer("‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à—É –∑–∞–º–µ—Ç–∫—É...")

    try:
        await enrich_post_with_metadata(post, db)

        tags_str = ", ".join(post.tags[:5]) if post.tags else "–Ω–µ—Ç"

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å", callback_data=f"publish_post:{post.id}")],
            [InlineKeyboardButton(text="üìù –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ—Ç–∫—É", callback_data=f"view_post:{post.id}")],
            [InlineKeyboardButton(text="¬´ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")],
        ])

        await message.answer(
            f"‚úÖ <b>–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</b>\n\n"
            f"üìä –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {post.category or '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}\n"
            f"üè∑ –¢–µ–≥–∏: {tags_str}\n"
            f"üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {post.sentiment or 'neutral'}\n\n"
            f"ID: {post.id}",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("post_enrichment_failed", error=str(e))
        await message.answer(
            f"‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (ID: {post.id})\n\n"
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.",
            reply_markup=get_main_menu_keyboard()
        )

    await state.clear()


@router.callback_query(F.data == "post_ai_assisted")
async def callback_post_ai_assisted(callback: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å AI."""
    await callback.answer()

    await state.set_state(PersonalPostStates.waiting_ai_ideas)
    await state.update_data(previous_attempts=[])

    await callback.message.edit_text(
        "ü§ñ <b>–°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É —Å –ø–æ–º–æ—â—å—é AI</b>\n\n"
        "–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –∏–¥–µ–∏, –º—ã—Å–ª–∏ –∏–ª–∏ —Ç–æ, –æ —á—ë–º —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å.\n"
        "–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä —Ç–µ–∑–∏—Å–æ–≤ –∏–ª–∏ –≤–æ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.\n\n"
        "AI —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏–∑ —ç—Ç–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞–º–µ—Ç–∫—É.\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à–∏ –∏–¥–µ–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ–º:",
        parse_mode="HTML"
    )


@router.message(PersonalPostStates.waiting_ai_ideas)
async def process_ai_ideas(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–¥–µ–∏ –¥–ª—è AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏."""
    from app.modules.personal_posts_manager import generate_post_with_ai, create_personal_post
    from app.modules.settings_manager import get_llm_model

    user_input = message.text

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä typing
    await message.bot.send_chat_action(message.chat.id, "typing")

    processing_msg = await message.answer("ü§ñ AI —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤–∞—à—É –∑–∞–º–µ—Ç–∫—É...")

    try:
        # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        model = await get_llm_model("draft_generation", db)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç
        data = await state.get_data()
        previous_attempts = data.get("previous_attempts", [])

        generated_content = await generate_post_with_ai(
            user_input=user_input,
            model=model,
            previous_attempts=previous_attempts if previous_attempts else None
        )

        await processing_msg.delete()

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
        await state.update_data(
            current_content=generated_content,
            raw_input=user_input,
            model_used=model
        )
        await state.set_state(PersonalPostStates.waiting_ai_feedback)

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="ai_post_save")],
            [InlineKeyboardButton(text="üîÑ –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å", callback_data="ai_post_regenerate")],
            [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="ai_post_cancel")],
        ])

        await message.answer(
            f"ü§ñ <b>–í–æ—Ç —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å:</b>\n\n"
            f"{generated_content}\n\n"
            "–í–∞—Å —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç?",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("ai_generation_failed", error=str(e))
        await processing_msg.delete()
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()


@router.callback_query(F.data == "ai_post_save")
async def callback_ai_post_save(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç."""
    await callback.answer()

    from app.modules.personal_posts_manager import create_personal_post, enrich_post_with_metadata

    data = await state.get_data()
    content = data.get("current_content")
    raw_input = data.get("raw_input")
    model_used = data.get("model_used")

    if not content:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return

    await callback.message.edit_text("‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–º–µ—Ç–∫—É...")

    # –°–æ–∑–¥–∞—ë–º –ø–æ—Å—Ç
    post = await create_personal_post(
        user_id=callback.from_user.id,
        content=content,
        db=db,
        creation_method="ai_assisted",
        raw_input=raw_input,
        ai_model_used=model_used
    )

    # –û–±–æ–≥–∞—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    try:
        await enrich_post_with_metadata(post, db)

        tags_str = ", ".join(post.tags[:5]) if post.tags else "–Ω–µ—Ç"

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å", callback_data=f"publish_post:{post.id}")],
            [InlineKeyboardButton(text="üìù –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ—Ç–∫—É", callback_data=f"view_post:{post.id}")],
            [InlineKeyboardButton(text="¬´ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")],
        ])

        await callback.message.answer(
            f"‚úÖ <b>–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</b>\n\n"
            f"üìä –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {post.category or '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}\n"
            f"üè∑ –¢–µ–≥–∏: {tags_str}\n"
            f"ü§ñ –ú–æ–¥–µ–ª—å: {model_used}\n\n"
            f"ID: {post.id}",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("post_enrichment_failed", error=str(e))
        await callback.message.answer(
            f"‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (ID: {post.id})\n\n"
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
            reply_markup=get_main_menu_keyboard()
        )

    await state.clear()


@router.callback_query(F.data == "ai_post_regenerate")
async def callback_ai_post_regenerate(callback: CallbackQuery, state: FSMContext):
    """–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç."""
    await callback.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–ª–∏ –Ω–æ–≤—ã–µ –∏–¥–µ–∏")

    data = await state.get_data()
    current_content = data.get("current_content")

    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–ø—ã—Ç–∫—É –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö
    previous_attempts = data.get("previous_attempts", [])
    previous_attempts.append(current_content)
    await state.update_data(previous_attempts=previous_attempts)

    await state.set_state(PersonalPostStates.waiting_ai_ideas)

    await callback.message.edit_text(
        "üîÑ <b>–ü–µ—Ä–µ–¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ç–∫—É</b>\n\n"
        "–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –∏–ª–∏ –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å—Ç–∏.\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏.\n\n"
        "AI —É—á—Ç—ë—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é:",
        parse_mode="HTML"
    )


@router.callback_query(F.data == "ai_post_cancel")
async def callback_ai_post_cancel(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ AI –ø–æ—Å—Ç–∞."""
    await callback.answer("–û—Ç–º–µ–Ω–µ–Ω–æ")
    await state.clear()

    await callback.message.edit_text(
        "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
        reply_markup=get_main_menu_keyboard()
    )


@router.callback_query(F.data == "post_voice")
async def callback_post_voice(callback: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –≥–æ–ª–æ—Å–æ–º."""
    await callback.answer()

    await state.set_state(PersonalPostStates.waiting_voice)

    await callback.message.edit_text(
        "üé§ <b>–ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–∞—à–∏–º–∏ –º—ã—Å–ª—è–º–∏.\n\n"
        "–Ø —Ä–∞—Å—à–∏—Ñ—Ä—É—é –µ–≥–æ –∏ —Å–æ–∑–¥–∞–º –∑–∞–º–µ—Ç–∫—É.\n"
        "–ü–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å:\n"
        "‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å\n"
        "‚Ä¢ –î–∞—Ç—å AI –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
        parse_mode="HTML"
    )


@router.message(PersonalPostStates.waiting_voice, F.voice)
async def process_voice_post(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    from app.modules.personal_posts_manager import transcribe_voice
    import os
    import tempfile

    # –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    voice = message.voice
    file = await message.bot.get_file(voice.file_id)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    with tempfile.NamedTemporaryFile(delete=False, suffix=".ogg") as temp_file:
        await message.bot.download_file(file.file_path, temp_file.name)
        audio_path = temp_file.name

    processing_msg = await message.answer("üéß –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")

    try:
        # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º
        transcribed_text = await transcribe_voice(audio_path)

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        os.unlink(audio_path)

        await processing_msg.delete()

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–ø—Ü–∏–∏
        await state.update_data(transcribed_text=transcribed_text)
        await state.set_state(PersonalPostStates.waiting_ai_feedback)

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å", callback_data="voice_save_raw")],
            [InlineKeyboardButton(text="ü§ñ –£–ª—É—á—à–∏—Ç—å —Å AI", callback_data="voice_improve_ai")],
            [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="ai_post_cancel")],
        ])

        await message.answer(
            f"üé§ <b>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:</b>\n\n"
            f"{transcribed_text}\n\n"
            "–ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("voice_transcription_failed", error=str(e))
        os.unlink(audio_path)
        await processing_msg.delete()
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()


@router.callback_query(F.data == "voice_save_raw")
async def callback_voice_save_raw(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –≥–æ–ª–æ—Å–∞ –∫–∞–∫ –µ—Å—Ç—å."""
    await callback.answer()

    from app.modules.personal_posts_manager import create_personal_post, enrich_post_with_metadata

    data = await state.get_data()
    content = data.get("transcribed_text")

    if not content:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞: —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return

    await callback.message.edit_text("‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é –∑–∞–º–µ—Ç–∫—É...")

    # –°–æ–∑–¥–∞—ë–º –ø–æ—Å—Ç
    post = await create_personal_post(
        user_id=callback.from_user.id,
        content=content,
        db=db,
        creation_method="voice"
    )

    # –û–±–æ–≥–∞—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    try:
        await enrich_post_with_metadata(post, db)

        tags_str = ", ".join(post.tags[:5]) if post.tags else "–Ω–µ—Ç"

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å", callback_data=f"publish_post:{post.id}")],
            [InlineKeyboardButton(text="üìù –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ—Ç–∫—É", callback_data=f"view_post:{post.id}")],
            [InlineKeyboardButton(text="¬´ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")],
        ])

        await callback.message.answer(
            f"‚úÖ <b>–ó–∞–º–µ—Ç–∫–∞ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</b>\n\n"
            f"üìä –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {post.category or '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}\n"
            f"üè∑ –¢–µ–≥–∏: {tags_str}\n\n"
            f"ID: {post.id}",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("post_enrichment_failed", error=str(e))
        await callback.message.answer(
            f"‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (ID: {post.id})",
            reply_markup=get_main_menu_keyboard()
        )

    await state.clear()


@router.callback_query(F.data == "voice_improve_ai")
async def callback_voice_improve_ai(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–£–ª—É—á—à–∏—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –≥–æ–ª–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é AI."""
    await callback.answer()

    from app.modules.personal_posts_manager import generate_post_with_ai
    from app.modules.settings_manager import get_llm_model

    data = await state.get_data()
    transcribed_text = data.get("transcribed_text")

    if not transcribed_text:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞: —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return

    await callback.message.edit_text("ü§ñ AI —É–ª—É—á—à–∞–µ—Ç –≤–∞—à—É –∑–∞–º–µ—Ç–∫—É...")

    try:
        model = await get_llm_model("draft_generation", db)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        improved_content = await generate_post_with_ai(
            user_input=transcribed_text,
            model=model
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è feedback
        await state.update_data(
            current_content=improved_content,
            raw_input=transcribed_text,
            model_used=model
        )

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="ai_post_save")],
            [InlineKeyboardButton(text="üîÑ –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å", callback_data="ai_post_regenerate")],
            [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="ai_post_cancel")],
        ])

        await callback.message.answer(
            f"ü§ñ <b>–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:</b>\n\n"
            f"{improved_content}\n\n"
            "–í–∞—Å —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç?",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("ai_improvement_failed", error=str(e))
        await callback.message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()


@router.callback_query(F.data == "list_personal_posts")
async def callback_list_personal_posts(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ª–∏—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤."""
    await callback.answer()

    from app.modules.personal_posts_manager import get_user_posts

    posts = await get_user_posts(callback.from_user.id, db, limit=20)

    if not posts:
        await callback.message.edit_text(
            "üìö <b>–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏</b>\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫.\n"
            "–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É", callback_data="create_personal_post")],
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="show_personal_posts")],
            ])
        )
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
    posts_list = "üìö <b>–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ (–¥–Ω–µ–≤–Ω–∏–∫)</b>\n\n"
    posts_list += "<i>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–º–µ—Ç–∫—É —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å:</i>\n\n"

    buttons = []
    for i, post in enumerate(posts, 1):
        date_str = post.created_at.strftime("%d.%m %H:%M")
        title = post.title or post.content[:40] + "..."
        method_icon = {"manual": "‚úçÔ∏è", "ai_assisted": "ü§ñ", "voice": "üé§"}.get(post.creation_method, "üìù")
        published_icon = "‚úÖ" if post.published else ""

        buttons.append([
            InlineKeyboardButton(
                text=f"{method_icon} {published_icon} {date_str}: {title}",
                callback_data=f"view_post:{post.id}"
            )
        ])

    buttons.append([InlineKeyboardButton(text="‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é", callback_data="create_personal_post")])
    buttons.append([InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="show_personal_posts")])

    await callback.message.edit_text(
        posts_list + f"\n<i>–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫: {len(posts)}</i>",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
    )


@router.callback_query(F.data.startswith("view_post:"))
async def callback_view_post(callback: CallbackQuery, db: AsyncSession):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–º–µ—Ç–∫–∏."""
    await callback.answer()

    post_id = int(callback.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–º–µ—Ç–∫—É
    result = await db.execute(
        select(PersonalPost).where(
            PersonalPost.id == post_id,
            PersonalPost.user_id == callback.from_user.id
        )
    )
    post = result.scalar_one_or_none()

    if not post:
        await callback.answer("‚ùå –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    date_str = post.created_at.strftime("%d.%m.%Y %H:%M")
    method_names = {"manual": "–í—Ä—É—á–Ω—É—é", "ai_assisted": "–° –ø–æ–º–æ—â—å—é AI", "voice": "–ì–æ–ª–æ—Å–æ–º"}
    method = method_names.get(post.creation_method, post.creation_method)

    post_text = f"üìù <b>–ó–∞–º–µ—Ç–∫–∞ #{post.id}</b>\n"
    post_text += f"üìÖ {date_str}\n"
    post_text += f"üîß –ú–µ—Ç–æ–¥: {method}\n"

    if post.category:
        post_text += f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {post.category}\n"
    if post.tags:
        post_text += f"üè∑ –¢–µ–≥–∏: {', '.join(post.tags[:5])}\n"
    if post.published:
        post_text += f"‚úÖ <b>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</b> {post.published_at.strftime('%d.%m.%Y')}\n"
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        if post.views_count or post.reactions_count:
            post_text += f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: üëÅ {post.views_count or 0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, üëç {post.reactions_count or 0} —Ä–µ–∞–∫—Ü–∏–π\n"

    post_text += f"\n{'‚îÄ' * 30}\n\n"
    post_text += f"{post.content}\n"
    post_text += f"\n{'‚îÄ' * 30}\n"

    # –ö–Ω–æ–ø–∫–∏
    buttons = []

    # –ö–Ω–æ–ø–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞ (–º–æ–∂–Ω–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
    if not post.published:
        buttons.append([InlineKeyboardButton(text="üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", callback_data=f"publish_post:{post.id}")])
    else:
        buttons.append([InlineKeyboardButton(text="üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data=f"publish_post:{post.id}")])

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    comments_result = await db.execute(
        select(PostComment).where(PostComment.post_id == post.id)
    )
    comments_count = len(list(comments_result.scalars().all()))

    comments_text = f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({comments_count})" if comments_count > 0 else "üí¨ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"

    buttons.append([
        InlineKeyboardButton(text=comments_text, callback_data=f"view_comments:{post.id}")
    ])

    buttons.append([
        InlineKeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"edit_post:{post.id}"),
        InlineKeyboardButton(text="üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"delete_post:{post.id}")
    ])
    buttons.append([InlineKeyboardButton(text="¬´ –ö —Å–ø–∏—Å–∫—É", callback_data="list_personal_posts")])

    await callback.message.edit_text(
        post_text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
    )


@router.callback_query(F.data.startswith("publish_post:"))
async def callback_publish_post(callback: CallbackQuery, db: AsyncSession):
    """–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ª–∏—á–Ω—É—é –∑–∞–º–µ—Ç–∫—É –≤ –∫–∞–Ω–∞–ª (–º–æ–∂–Ω–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)."""
    post_id = int(callback.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–º–µ—Ç–∫—É (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ published - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é)
    result = await db.execute(
        select(PersonalPost).where(
            PersonalPost.id == post_id,
            PersonalPost.user_id == callback.from_user.id
        )
    )
    post = result.scalar_one_or_none()

    if not post:
        await callback.answer("‚ùå –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è
    is_republish = post.published

    # –ü—É–±–ª–∏–∫—É–µ–º –≤ –∫–∞–Ω–∞–ª
    try:
        from app.config import settings
        import html
        import re

        # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç —Å–ª—É–∂–µ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        clean_content = post.content

        # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å —Å–ª—É–∂–µ–±–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
        service_headers = [
            r'^#+\s*(–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ|–ó–∞–º–µ—Ç–∫–∞|–ß–µ—Ä–Ω–æ–≤–∏–∫|Draft|Note|Edit).*?\n+',
            r'^\*\*\s*(–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ|–ó–∞–º–µ—Ç–∫–∞|–ß–µ—Ä–Ω–æ–≤–∏–∫|Draft|Note|Edit).*?\*\*\n+',
            r'^(–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ|–ó–∞–º–µ—Ç–∫–∞|–ß–µ—Ä–Ω–æ–≤–∏–∫):\s*\n+',
        ]
        for pattern in service_headers:
            clean_content = re.sub(pattern, '', clean_content, flags=re.IGNORECASE | re.MULTILINE)

        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
        clean_content = clean_content.lstrip('\n ')

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        publish_text = html.escape(clean_content)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if post.tags:
            escaped_tags = [html.escape(tag.replace(' ', '_')) for tag in post.tags[:5]]
            publish_text += f"\n\nüè∑ {' '.join(['#' + tag for tag in escaped_tags])}"

        # –ü—É–±–ª–∏–∫—É–µ–º (—Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML parse mode)
        message = await callback.bot.send_message(
            chat_id=settings.telegram_channel_id,
            text=publish_text,
            parse_mode="HTML"
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        post.published = True
        post.published_at = datetime.utcnow()
        post.telegram_message_id = message.message_id
        await db.commit()

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π
        success_msg = "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ —Å–Ω–æ–≤–∞!" if is_republish else "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!"
        await callback.answer(success_msg, show_alert=True)

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–º–µ—Ç–∫–∏ - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π callback data
        callback.data = f"view_post:{post_id}"
        await callback_view_post(callback, db)

    except Exception as e:
        logger.error("post_publication_error", error=str(e), post_id=post_id)
        await callback.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}", show_alert=True)


@router.callback_query(F.data.startswith("delete_post:"))
async def callback_delete_post(callback: CallbackQuery, db: AsyncSession):
    """–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É."""
    post_id = int(callback.data.split(":")[1])

    from app.modules.personal_posts_manager import delete_post

    success = await delete_post(post_id, callback.from_user.id, db)

    if success:
        await callback.answer("üóë –ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞", show_alert=True)
        await callback_list_personal_posts(callback, db)
    else:
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å", show_alert=True)


@router.callback_query(F.data.startswith("view_comments:"))
async def callback_view_comments(callback: CallbackQuery, db: AsyncSession):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–º–µ—Ç–∫–µ."""
    post_id = int(callback.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–º–µ—Ç–∫—É
    result = await db.execute(
        select(PersonalPost).where(
            PersonalPost.id == post_id,
            PersonalPost.user_id == callback.from_user.id
        )
    )
    post = result.scalar_one_or_none()

    if not post:
        await callback.answer("‚ùå –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    comments_result = await db.execute(
        select(PostComment)
        .where(PostComment.post_id == post.id)
        .order_by(PostComment.created_at.asc())
    )
    comments = list(comments_result.scalars().all())

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    text = f"üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–º–µ—Ç–∫–µ</b>\n\n"
    text += f"<b>–ó–∞–º–µ—Ç–∫–∞:</b> {post.title or post.content[:50]}...\n"
    text += f"{'‚îÄ' * 30}\n\n"

    if comments:
        for idx, comment in enumerate(comments, 1):
            date_str = comment.created_at.strftime("%d.%m %H:%M")
            comment_icon = {
                "reflection": "ü§î",
                "idea": "üí°",
                "question": "‚ùì",
                "update": "üìù"
            }.get(comment.comment_type, "üí¨")

            text += f"{comment_icon} <b>#{idx}</b> ({date_str})\n"
            text += f"{comment.content}\n\n"
    else:
        text += "<i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</i>\n\n"

    # –ö–Ω–æ–ø–∫–∏
    buttons = [
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", callback_data=f"add_comment:{post.id}")],
        [InlineKeyboardButton(text="¬´ –ö –∑–∞–º–µ—Ç–∫–µ", callback_data=f"view_post:{post.id}")]
    ]

    await callback.message.edit_text(
        text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
    )
    await callback.answer()


@router.callback_query(F.data.startswith("add_comment:"))
async def callback_add_comment(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–ù–∞—á–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è."""
    post_id = int(callback.data.split(":")[1])

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–º–µ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    result = await db.execute(
        select(PersonalPost).where(
            PersonalPost.id == post_id,
            PersonalPost.user_id == callback.from_user.id
        )
    )
    post = result.scalar_one_or_none()

    if not post:
        await callback.answer("‚ùå –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º post_id –≤ FSM
    await state.update_data(commenting_post_id=post_id)
    await state.set_state(PersonalPostStates.waiting_comment)

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    buttons = [
        [InlineKeyboardButton(text="ü§î –†–µ—Ñ–ª–µ–∫—Å–∏—è", callback_data=f"comment_type:reflection:{post_id}")],
        [InlineKeyboardButton(text="üí° –ò–¥–µ—è", callback_data=f"comment_type:idea:{post_id}")],
        [InlineKeyboardButton(text="‚ùì –í–æ–ø—Ä–æ—Å", callback_data=f"comment_type:question:{post_id}")],
        [InlineKeyboardButton(text="üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ", callback_data=f"comment_type:update:{post_id}")],
        [InlineKeyboardButton(text="¬´ –û—Ç–º–µ–Ω–∞", callback_data=f"view_comments:{post_id}")]
    ]

    await callback.message.edit_text(
        "üí¨ <b>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
    )
    await callback.answer()


@router.callback_query(F.data.startswith("comment_type:"))
async def callback_comment_type(callback: CallbackQuery, state: FSMContext):
    """–í—ã–±—Ä–∞–Ω —Ç–∏–ø –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è."""
    parts = callback.data.split(":")
    comment_type = parts[1]
    post_id = int(parts[2])

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    await state.update_data(comment_type=comment_type)

    type_names = {
        "reflection": "ü§î –†–µ—Ñ–ª–µ–∫—Å–∏—è",
        "idea": "üí° –ò–¥–µ—è",
        "question": "‚ùì –í–æ–ø—Ä–æ—Å",
        "update": "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
    }

    await callback.message.edit_text(
        f"{type_names.get(comment_type, '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π')}\n\n"
        f"–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:",
        parse_mode="HTML"
    )
    await callback.answer()


@router.message(PersonalPostStates.waiting_comment)
async def process_comment(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è."""
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ FSM
    data = await state.get_data()
    post_id = data.get("commenting_post_id")
    comment_type = data.get("comment_type", "reflection")

    if not post_id:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞–º–µ—Ç–∫–∏")
        await state.clear()
        return

    # –°–æ–∑–¥–∞—ë–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    comment = PostComment(
        post_id=post_id,
        user_id=message.from_user.id,
        content=message.text,
        comment_type=comment_type
    )

    db.add(comment)
    await db.commit()

    logger.info(
        "comment_added",
        post_id=post_id,
        comment_id=comment.id,
        comment_type=comment_type,
        user_id=message.from_user.id
    )

    # –û—á–∏—â–∞–µ–º FSM
    await state.clear()

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    buttons = [
        [InlineKeyboardButton(text="üí¨ –ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º", callback_data=f"view_comments:{post_id}")],
        [InlineKeyboardButton(text="¬´ –ö –∑–∞–º–µ—Ç–∫–µ", callback_data=f"view_post:{post_id}")]
    ]

    type_icons = {
        "reflection": "ü§î",
        "idea": "üí°",
        "question": "‚ùì",
        "update": "üìù"
    }

    await message.answer(
        f"‚úÖ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!</b>\n\n"
        f"{type_icons.get(comment_type, 'üí¨')} {message.text}",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
    )


@router.callback_query(F.data.startswith("edit_post:"))
async def callback_edit_post(callback: CallbackQuery, state: FSMContext, db: AsyncSession):
    """–ù–∞—á–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏."""
    post_id = int(callback.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–º–µ—Ç–∫—É
    result = await db.execute(
        select(PersonalPost).where(
            PersonalPost.id == post_id,
            PersonalPost.user_id == callback.from_user.id
        )
    )
    post = result.scalar_one_or_none()

    if not post:
        await callback.answer("‚ùå –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ—Å—Ç–∞ –≤ FSM –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    await state.update_data(editing_post_id=post_id)
    await state.set_state(PersonalPostStates.waiting_edit_text)

    await callback.message.edit_text(
        f"‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏</b>\n\n"
        f"<b>–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç:</b>\n{post.content}\n\n"
        f"{'‚îÄ' * 30}\n\n"
        f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –Ø –∑–∞–º–µ–Ω—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏ –∏ –æ–±–Ω–æ–≤–ª—é —Ç–µ–≥–∏.",
        parse_mode="HTML"
    )
    await callback.answer()


@router.message(PersonalPostStates.waiting_edit_text)
async def process_edit_post(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç."""
    from app.modules.personal_posts_manager import enrich_post_with_metadata

    # –ü–æ–ª—É—á–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞ –∏–∑ FSM
    data = await state.get_data()
    post_id = data.get("editing_post_id")

    if not post_id:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞")
        await state.clear()
        return

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç –∏–∑ –ë–î
    result = await db.execute(
        select(PersonalPost).where(
            PersonalPost.id == post_id,
            PersonalPost.user_id == message.from_user.id
        )
    )
    post = result.scalar_one_or_none()

    if not post:
        await message.answer("‚ùå –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        await state.clear()
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    post.content = message.text
    post.updated_at = datetime.utcnow()

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä typing
    await message.bot.send_chat_action(message.chat.id, "typing")
    await message.answer("‚è≥ –û–±–Ω–æ–≤–ª—è—é –∑–∞–º–µ—Ç–∫—É –∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ–≥–∏...")

    try:
        # –û–±–æ–≥–∞—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∑–∞–Ω–æ–≤–æ
        await enrich_post_with_metadata(post, db)

        tags_str = ", ".join(post.tags[:5]) if post.tags else "–Ω–µ—Ç"

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üëÅ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ—Ç–∫—É", callback_data=f"view_post:{post.id}")],
            [InlineKeyboardButton(text="üìã –ö —Å–ø–∏—Å–∫—É –∑–∞–º–µ—Ç–æ–∫", callback_data="list_personal_posts")],
            [InlineKeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")]
        ])

        await message.answer(
            f"‚úÖ <b>–ó–∞–º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</b>\n\n"
            f"üìÇ <b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> {post.category or '–Ω–µ—Ç'}\n"
            f"üè∑ <b>–¢–µ–≥–∏:</b> {tags_str}\n"
            f"üòä <b>–¢–æ–Ω:</b> {post.sentiment or '–Ω–µ—Ç'}",
            parse_mode="HTML",
            reply_markup=keyboard
        )

    except Exception as e:
        logger.error("post_edit_enrichment_error", error=str(e), post_id=post.id)
        await message.answer(
            f"‚ö†Ô∏è –ó–∞–º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–æ–≥–∞—Ç–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏.\n\n–û—à–∏–±–∫–∞: {str(e)}",
            parse_mode="HTML"
        )

    await state.clear()


@router.callback_query(F.data == "noop")
async def callback_noop(callback: CallbackQuery):
    """No operation - –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ callback."""
    await callback.answer()


@router.callback_query(F.data == "back_to_main_menu")
async def callback_back_to_main_menu(callback: CallbackQuery):
    """–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    await callback.answer()

    await callback.message.edit_text(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        parse_mode="HTML",
        reply_markup=get_main_menu_keyboard()
    )


@router.callback_query(F.data == "show_ai_analysis_menu")
async def callback_show_ai_analysis_menu(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞."""
    await callback.answer()

    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="ü§ñ 7 –¥–Ω–µ–π", callback_data="ai_analysis:7"),
            InlineKeyboardButton(text="ü§ñ 30 –¥–Ω–µ–π", callback_data="ai_analysis:30"),
        ],
        [
            InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_analytics_menu"),
        ]
    ])

    await callback.message.edit_text(
        "ü§ñ <b>AI –ê–Ω–∞–ª–∏–∑ –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n\n"
        "GPT-4 –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –¥–∞—Å—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ "
        "–ø–æ —É–ª—É—á—à–µ–Ω–∏—é engagement, –∫–æ–Ω—Ç–µ–Ω—Ç-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.callback_query(F.data == "back_to_analytics_menu")
async def callback_back_to_analytics_menu(callback: CallbackQuery):
    """–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é –∞–Ω–∞–ª–∏—Ç–∏–∫–∏."""
    await callback.answer()

    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üìÖ 7 –¥–Ω–µ–π", callback_data="analytics:7"),
            InlineKeyboardButton(text="üìÖ 30 –¥–Ω–µ–π", callback_data="analytics:30"),
        ],
        [
            InlineKeyboardButton(text="üìÖ –í—Å—ë –≤—Ä–µ–º—è", callback_data="analytics:all"),
        ],
        [
            InlineKeyboardButton(text="ü§ñ AI –ê–Ω–∞–ª–∏–∑", callback_data="show_ai_analysis_menu"),
        ]
    ])

    await callback.message.edit_text(
        "üìä <b>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:</b>",
        parse_mode="HTML",
        reply_markup=keyboard
    )


@router.callback_query(F.data.startswith("analytics:"))
async def callback_analytics(callback: CallbackQuery, db: AsyncSession):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∑–∞ –ø–µ—Ä–∏–æ–¥."""

    await callback.answer()

    if not await check_admin(callback.from_user.id):
        await callback.message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return

    try:
        period = callback.data.split(":")[1]
        days = int(period) if period != "all" else 9999

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading —Å–æ–æ–±—â–µ–Ω–∏–µ
        loading_msg = await callback.message.answer(
            "‚è≥ <b>–°–æ–±–∏—Ä–∞—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É...</b>\n\n"
            "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –º–µ—Ç—Ä–∏–∫–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏...",
            parse_mode="HTML"
        )

        logger.info("analytics_requested", period=period, days=days, user_id=callback.from_user.id)

        # –°–æ–∑–¥–∞—ë–º —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        analytics = AnalyticsService(db)

        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–±–∞–∑–æ–≤—ã–µ + –Ω–æ–≤—ã–µ)
        stats = await analytics.get_period_stats(days)
        top_posts = await analytics.get_top_posts(3, days)
        worst_posts = await analytics.get_worst_posts(3, days)
        sources = await analytics.get_source_stats(days)
        weekday_stats = await analytics.get_weekday_stats(min(days, 30))  # –ú–∞–∫—Å–∏–º—É–º 30 –¥–Ω–µ–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –¥–Ω—è–º
        vector_stats = await analytics.get_vector_db_stats()
        source_recommendations = await analytics.get_source_recommendations(min(days, 30))

        # –ù–û–í–´–ï –º–µ—Ç–æ–¥—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        views_stats = await analytics.get_views_and_forwards_stats(days)
        best_time = await analytics.get_best_publish_time(min(days, 30))
        trending_topics = await analytics.get_trending_topics(days, top_n=5)
        alerts = await analytics.get_performance_alerts(days)

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç
        report = format_analytics_report(
            stats=stats,
            top_posts=top_posts,
            worst_posts=worst_posts,
            sources=sources,
            weekday_stats=weekday_stats,
            vector_stats=vector_stats,
            source_recommendations=source_recommendations,
            views_stats=views_stats,
            best_time=best_time,
            trending_topics=trending_topics,
            alerts=alerts
        )


        # –£–¥–∞–ª—è–µ–º loading —Å–æ–æ–±—â–µ–Ω–∏–µ
        await loading_msg.delete()

        # Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤
        # –ï—Å–ª–∏ –æ—Ç—á—ë—Ç –¥–ª–∏–Ω–Ω—ã–π - —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
        if len(report) > 4096:
            # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º
            parts = report.split("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")

            current_part = ""
            for part in parts:
                if len(current_part + part) > 4000:
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç—å
                    await callback.message.answer(current_part, parse_mode="HTML", disable_web_page_preview=True)
                    current_part = part
                else:
                    current_part += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" + part if current_part else part

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å
            if current_part:
                await callback.message.answer(current_part, parse_mode="HTML", disable_web_page_preview=True)
        else:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª–∏–∫–æ–º
            await callback.message.answer(report, parse_mode="HTML", disable_web_page_preview=True)

        logger.info("analytics_sent", period=period, report_length=len(report))

    except Exception as e:
        logger.error("analytics_error", error=str(e), period=callback.data)
        # –£–¥–∞–ª—è–µ–º loading —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        try:
            await loading_msg.delete()
        except:
            pass
        await callback.message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode="HTML"
        )


@router.callback_query(F.data.startswith("ai_analysis:"))
async def callback_ai_analysis(callback: CallbackQuery, db: AsyncSession):
    """AI-–∞–Ω–∞–ª–∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –æ—Ç GPT-4."""

    await callback.answer()

    if not await check_admin(callback.from_user.id):
        await callback.message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return

    try:
        period = callback.data.split(":")[1]
        days = int(period) if period != "all" else 30  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞

        loading_msg = await callback.message.answer(
            "ü§ñ <b>AI –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...</b>\n\n"
            "‚è≥ –°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –º–µ—Ç—Ä–∏–∫–∏...\n"
            "‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ GPT-4...",
            parse_mode="HTML"
        )

        logger.info("ai_analysis_requested", period=period, days=days, user_id=callback.from_user.id)

        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        analytics = AnalyticsService(db)

        stats = await analytics.get_period_stats(days)
        top_posts = await analytics.get_top_posts(3, days)
        worst_posts = await analytics.get_worst_posts(3, days)
        sources = await analytics.get_source_stats(days)
        views_stats = await analytics.get_views_and_forwards_stats(days)
        best_time = await analytics.get_best_publish_time(min(days, 30))
        trending_topics = await analytics.get_trending_topics(days, top_n=5)
        alerts = await analytics.get_performance_alerts(days)
        source_recommendations = await analytics.get_source_recommendations(min(days, 30))

        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GPT
        analytics_data = f"""
–ü–ï–†–ò–û–î –ê–ù–ê–õ–ò–ó–ê: {days} –¥–Ω–µ–π

–û–°–ù–û–í–ù–´–ï –ú–ï–¢–†–ò–ö–ò:
- –ü—É–±–ª–∏–∫–∞—Ü–∏–π: {stats['total_publications']}
- –û–¥–æ–±—Ä–µ–Ω–æ –¥—Ä–∞—Ñ—Ç–æ–≤: {stats['approved_drafts']} –∏–∑ {stats['total_drafts']} ({stats['approval_rate']:.1f}%)
- Engagement rate: {stats['engagement_rate']:.1f}%
- Avg quality score: {stats['avg_quality_score']}

–†–ï–ê–ö–¶–ò–ò:
- –ü–æ–ª–µ–∑–Ω–æ: {stats['reactions']['useful']}
- –í–∞–∂–Ω–æ: {stats['reactions']['important']}
- –°–ø–æ—Ä–Ω–æ: {stats['reactions']['controversial']}
- –ë–∞–Ω–∞–ª—å–Ω–æ: {stats['reactions']['banal']}
- –ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ: {stats['reactions']['poor_quality']}

VIEWS –ò FORWARDS:
- –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {views_stats.get('total_views', 0)}
- Avg –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤/–ø–æ—Å—Ç: {views_stats.get('avg_views', 0)}
- –í—Å–µ–≥–æ —Ñ–æ—Ä–≤–∞—Ä–¥–æ–≤: {views_stats.get('total_forwards', 0)}
- Viral coefficient: {views_stats.get('viral_coefficient', 0)}%

–õ–£–ß–®–ï–ï –í–†–ï–ú–Ø –ü–£–ë–õ–ò–ö–ê–¶–ò–ò:
{best_time.get('recommendation', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')}

–¢–†–ï–ù–î–û–í–´–ï –¢–ï–ú–´:
{chr(10).join([f"- {t['topic']} ({t['mentions']} —É–ø–æ–º–∏–Ω–∞–Ω–∏–π)" for t in trending_topics[:5]]) if trending_topics else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}

–¢–û–ü-3 –ü–û–°–¢–ê:
{chr(10).join([f"- {p['title'][:60]}... (quality: {p['quality_score']})" for p in top_posts[:3]]) if top_posts else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}

–•–£–î–®–ò–ï –ü–û–°–¢–´:
{chr(10).join([f"- {p['title'][:60]}... (quality: {p['quality_score']})" for p in worst_posts[:3]]) if worst_posts else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}

–ü–†–û–ë–õ–ï–ú–ù–´–ï –ò–°–¢–û–ß–ù–ò–ö–ò:
{chr(10).join([f"- {s['source_name']}: {s['recommendation']}" for s in source_recommendations[:3]]) if source_recommendations else '–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º'}

–ê–õ–ï–†–¢–´:
{chr(10).join([f"[{a['severity'].upper()}] {a['message']}" for a in alerts]) if alerts else '–ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤'}
"""

        # –í—ã–∑—ã–≤–∞–µ–º GPT-4 –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        from app.modules.ai_core import call_openai_chat

        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ Telegram –∫–∞–Ω–∞–ª–æ–≤ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–∞–Ω–∞–ª–∞ @legal_ai_pro (–Ω–æ–≤–æ—Å—Ç–∏ –æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –ò–ò –≤ —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—é –∏ –±–∏–∑–Ω–µ—Å):

{analytics_data}

–î–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ê–ù–ê–õ–ò–ó –°–ò–¢–£–ê–¶–ò–ò** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
   - –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–Ω–∞–ª–∞
   - –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

2. **–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò** (—Ç–æ–ø-3, –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫):
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
   - –§–æ–∫—É—Å –Ω–∞ engagement, quality score, –∏ viral coefficient

3. **–ö–û–ù–¢–ï–ù–¢-–°–¢–†–ê–¢–ï–ì–ò–Ø**:
   - –ö–∞–∫–∏–µ —Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ (–Ω–∞ –æ—Å–Ω–æ–≤–µ trending topics)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ö—É–¥—à–∏—Ö –ø–æ—Å—Ç–æ–≤
   - –ö–∞–∫ –ø–æ–≤—ã—Å–∏—Ç—å viral coefficient

4. **–ò–°–¢–û–ß–ù–ò–ö–ò –ö–û–ù–¢–ï–ù–¢–ê**:
   - –ö–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å—Ç–æ–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–∏—Å–∫—É –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

5. **–¢–ê–ô–ú–ò–ù–ì –ü–£–ë–õ–ò–ö–ê–¶–ò–ô**:
   - –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —á–∞—Å—Ç–æ—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å —ç–º–æ–¥–∑–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ actionable —Å–æ–≤–µ—Ç–∞–º–∏. –ù–µ –±–æ–ª–µ–µ 800 —Å–ª–æ–≤."""

        ai_response, usage_stats = await call_openai_chat(
            messages=[{"role": "user", "content": prompt}],
            model="gpt-4o",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            temperature=0.7,
            max_tokens=2000,
            db=db,
            operation="ai_analysis"
        )

        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É AI –∞–Ω–∞–ª–∏–∑–æ–≤
        ai_stats = await analytics.get_ai_analysis_stats()

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        report = f"""ü§ñ <b>AI –ê–ù–ê–õ–ò–ó –ê–ù–ê–õ–ò–¢–ò–ö–ò</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

{ai_response}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<i>–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω GPT-4 –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞ {days} –¥–Ω–µ–π</i>
üìÖ {datetime.now().strftime('%d.%m.%Y %H:%M')}

üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:</b>
üìä –¢–æ–∫–µ–Ω–æ–≤: {usage_stats['total_tokens']:,} (prompt: {usage_stats['prompt_tokens']:,}, completion: {usage_stats['completion_tokens']:,})
üíµ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${usage_stats['cost_usd']:.4f}

üìà <b>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ AI –∞–Ω–∞–ª–∏–∑–æ–≤:</b>
‚Ä¢ –ó–∞ –º–µ—Å—è—Ü: {ai_stats['month']['count']} –∑–∞–ø—Ä–æ—Å–æ–≤, {ai_stats['month']['total_tokens']:,} —Ç–æ–∫–µ–Ω–æ–≤, ${ai_stats['month']['total_cost_usd']:.2f}
‚Ä¢ –ó–∞ –≥–æ–¥: {ai_stats['year']['count']} –∑–∞–ø—Ä–æ—Å–æ–≤, {ai_stats['year']['total_tokens']:,} —Ç–æ–∫–µ–Ω–æ–≤, ${ai_stats['year']['total_cost_usd']:.2f}"""

        # –£–¥–∞–ª—è–µ–º loading —Å–æ–æ–±—â–µ–Ω–∏–µ
        await loading_msg.delete()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–±–∏–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        if len(report) > 4096:
            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
            parts = report.split("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
            for i, part in enumerate(parts):
                if part.strip():
                    await callback.message.answer(
                        part if i == 0 else "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" + part,
                        parse_mode="HTML",
                        disable_web_page_preview=True
                    )
        else:
            await callback.message.answer(report, parse_mode="HTML", disable_web_page_preview=True)

        logger.info("ai_analysis_sent", period=period, response_length=len(ai_response))

    except Exception as e:
        logger.error("ai_analysis_error", error=str(e), period=callback.data)
        # –£–¥–∞–ª—è–µ–º loading —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        try:
            await loading_msg.delete()
        except:
            pass
        await callback.message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ AI –∞–Ω–∞–ª–∏–∑–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.\n\n"
            f"–û—à–∏–±–∫–∞: {str(e)}",
            parse_mode="HTML"
        )


@router.message(Command("alerts"))
async def cmd_alerts(message: Message, db: AsyncSession):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö."""

    if not await check_admin(message.from_user.id):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
        return

    await message.answer("üîç –ü—Ä–æ–≤–µ—Ä—è—é –º–µ—Ç—Ä–∏–∫–∏...")

    try:
        analytics = AnalyticsService(db)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        alerts = await analytics.get_performance_alerts(days=7)

        if not alerts:
            await message.answer(
                "‚úÖ <b>–í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ!</b>\n\n"
                "–ü—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.",
                parse_mode="HTML"
            )
        else:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç —Å –∞–ª–µ—Ä—Ç–∞–º–∏
            report = "üö® <b>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:</b>\n\n"

            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ severity
            critical = [a for a in alerts if a.get('severity') == 'critical']
            warnings = [a for a in alerts if a.get('severity') == 'warning']
            info = [a for a in alerts if a.get('severity') == 'info']

            if critical:
                report += "üî¥ <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï:</b>\n"
                for alert in critical:
                    report += f"{alert['message']}\n"
                    report += f"   ‚îî‚îÄ {alert['details']}\n\n"

            if warnings:
                report += "‚ö†Ô∏è <b>–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:</b>\n"
                for alert in warnings:
                    report += f"{alert['message']}\n"
                    report += f"   ‚îî‚îÄ {alert['details']}\n\n"

            if info:
                report += "üí° <b>–ò–ù–§–û–†–ú–ê–¶–ò–Ø:</b>\n"
                for alert in info:
                    report += f"{alert['message']}\n"
                    report += f"   ‚îî‚îÄ {alert['details']}\n\n"

            report += f"\nüìÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}"

            await message.answer(report, parse_mode="HTML")

        logger.info("alerts_checked", user_id=message.from_user.id, alerts_count=len(alerts))

    except Exception as e:
        logger.error("alerts_error", error=str(e))
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–ª–µ—Ä—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode="HTML"
        )


# ====================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
# ====================

async def setup_bot_commands():
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (–∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é —Å–ª–µ–≤–∞ –≤–Ω–∏–∑—É)."""
    commands = [
        BotCommand(command="start", description="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        BotCommand(command="drafts", description="üìù –ù–æ–≤—ã–µ –¥—Ä–∞—Ñ—Ç—ã"),
        BotCommand(command="fetch", description="üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π"),
        BotCommand(command="analytics", description="üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞"),
        BotCommand(command="moderation", description="üõ°Ô∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏"),
        BotCommand(command="lead_analytics", description="üéØ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ª–∏–¥–æ–≤"),
        BotCommand(command="alerts", description="üö® –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã"),
        BotCommand(command="stats", description="üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"),
        BotCommand(command="help", description="‚ùì –ü–æ–º–æ—â—å"),
    ]
    await get_bot().set_my_commands(commands)
    logger.info("bot_commands_set", count=len(commands))


@router.callback_query(F.data == "settings:fetcher")
async def callback_settings_fetcher(callback: CallbackQuery, db: AsyncSession):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π."""
    from app.modules.settings_manager import get_setting

    max_articles = await get_setting("fetcher.max_articles_per_source", db, 300)

    await callback.message.edit_text(
        f"üîÑ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</b>\n\n"
        f"üìä <b>–ú–∞–∫—Å–∏–º—É–º —Å—Ç–∞—Ç–µ–π –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫:</b> {max_articles}\n\n"
        f"üéØ <b>–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</b> 12 –∞–∫—Ç–∏–≤–Ω—ã—Ö\n\n"
        f"üí° <b>–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–±–æ—Ä–∫—É:</b> {max_articles * 12} —Å—Ç–∞—Ç–µ–π\n\n"
        f"‚öôÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(text="- 50", callback_data="fetcher:dec:50"),
                InlineKeyboardButton(text="- 10", callback_data="fetcher:dec:10"),
                InlineKeyboardButton(text="+ 10", callback_data="fetcher:inc:10"),
                InlineKeyboardButton(text="+ 50", callback_data="fetcher:inc:50"),
            ],
            [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")]
        ])
    )
    await callback.answer()


@router.callback_query(F.data.startswith("fetcher:inc:") | F.data.startswith("fetcher:dec:"))
async def callback_fetcher_adjust(callback: CallbackQuery, db: AsyncSession):
    """–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π."""
    from app.modules.settings_manager import get_setting, set_setting
    from aiogram.exceptions import TelegramBadRequest

    # Parse action and value
    parts = callback.data.split(":")
    action = parts[1]  # "inc" or "dec"
    value = int(parts[2])

    # Get current value
    max_articles = await get_setting("fetcher.max_articles_per_source", db, 300)

    # Update value
    if action == "inc":
        new_value = max_articles + value
    else:
        new_value = max(10, max_articles - value)  # Minimum 10 articles

    # Save new value
    await set_setting("fetcher.max_articles_per_source", new_value, db)

    # Update message - always try to update
    try:
        await callback.message.edit_text(
            f"üîÑ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</b>\n\n"
            f"üìä <b>–ú–∞–∫—Å–∏–º—É–º —Å—Ç–∞—Ç–µ–π –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫:</b> {new_value}\n\n"
            f"üéØ <b>–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</b> 12 –∞–∫—Ç–∏–≤–Ω—ã—Ö\n\n"
            f"üí° <b>–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–±–æ—Ä–∫—É:</b> {new_value * 12} —Å—Ç–∞—Ç–µ–π\n\n"
            f"‚öôÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="- 50", callback_data="fetcher:dec:50"),
                    InlineKeyboardButton(text="- 10", callback_data="fetcher:dec:10"),
                    InlineKeyboardButton(text="+ 10", callback_data="fetcher:inc:10"),
                    InlineKeyboardButton(text="+ 50", callback_data="fetcher:inc:50"),
                ],
                [InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="back_to_settings")]
            ])
        )
    except TelegramBadRequest:
        # Message not modified - ignore
        pass

    # Show notification
    if new_value != max_articles:
        await callback.answer(f"‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {new_value} —Å—Ç–∞—Ç–µ–π –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫")
    else:
        await callback.answer(f"‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 10 —Å—Ç–∞—Ç–µ–π")


# ====================
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# ====================

async def start_bot():
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞."""
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
    from app.models.database import init_db, get_db
    from app.modules.settings_manager import init_default_settings
    try:
        await init_db()
        logger.info("database_initialized")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async for db in get_db():
            await init_default_settings(db)
            logger.info("default_settings_initialized")
            break

    except Exception as e:
        logger.error("database_init_error", error=str(e))

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware –¥–ª—è –ë–î —Å–µ—Å—Å–∏–π
    dp.message.middleware(DbSessionMiddleware())
    dp.callback_query.middleware(DbSessionMiddleware())

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä
    dp.include_router(router)

    logger.info("bot_starting")

    # –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    logger.info("deleting_webhook")
    await get_bot().delete_webhook(drop_pending_updates=True)

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–Ω—é –∫–æ–º–∞–Ω–¥
    await setup_bot_commands()

    # –ó–∞–ø—É—Å–∫–∞–µ–º polling
    await dp.start_polling(get_bot())


if __name__ == "__main__":
    asyncio.run(start_bot())

